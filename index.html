<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>æ´»å‹•è¼‰å…¥ä¸­...</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* åŸºç¤è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; 
            background: #fdf5e6; 
            text-align: center; 
            margin: 0; 
            padding: 20px 10px 140px 10px; 
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
        }
        
        h1 { color: #b71c1c; margin: 10px 0 5px 0; font-size: 1.8em; letter-spacing: 1px; font-weight: 800; }
        .sub-title { color: #666; font-size: 0.95em; margin-bottom: 25px; line-height: 1.5; }
        .user-greeting { color: #b71c1c; font-weight: bold; }
        
        .version-tag { position: fixed; bottom: 5px; right: 5px; font-size: 9px; color: #ccc; z-index: 50; opacity: 0.5; }

        .grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            max-width: 600px;
            margin: 0 auto;
        }

        .cell {
            aspect-ratio: 1/1; 
            background: white;
            border: 1.5px solid #b71c1c;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        
        .cell:active { transform: scale(0.95); }
        .cell.active { background: #b71c1c; color: white; border-color: #8e1616; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        
        .icon { font-size: 18px; margin-bottom: 2px; line-height: 1; }
        .region { font-size: 10px; color: #888; margin-bottom: 2px; transform: scale(0.9); }
        .cell.active .region { color: #ffcccc; }
        .name { font-weight: bold; line-height: 1.1; font-size: 10px; width: 100%; word-break: break-all; }
        
        .count-badge {
            position: absolute; bottom: 2px; right: 2px;
            background: #fff; color: #b71c1c;
            font-size: 9px; font-weight: 800;
            padding: 1px 4px; border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: none;
        }
        .cell.active .count-badge { display: block; }
        .debug-click-indicator { position: absolute; top: 2px; left: 2px; width: 4px; height: 4px; border-radius: 50%; background: #ccc; display: none; }

        @media (max-width: 360px) {
            .name { font-size: 9px; transform: scale(0.95); }
            .icon { font-size: 14px; }
            .grid { gap: 3px; }
        }

        .bottom-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px; border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; gap: 10px; align-items: center; 
            white-space: nowrap; z-index: 100;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .status-text { font-size: 11px; color: #555; text-align: left; line-height: 1.2; margin-right: 5px; min-width: 120px;}

        .btn { 
            background: linear-gradient(135deg, #d32f2f, #b71c1c); 
            color: white; border: none; padding: 12px 24px; 
            border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 15px; 
            box-shadow: 0 4px 10px rgba(183, 28, 28, 0.3);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        
        .rank-btn {
            position: absolute; top: 15px; right: 15px;
            background: #fbc02d; color: #333;
            border: none; padding: 8px 12px; border-radius: 20px;
            font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        #rank-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            justify-content: center; align-items: center;
        }
        .rank-box {
            background: white; width: 85%; max-width: 400px; max-height: 80%;
            border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;
        }
        .rank-header {
            background: #b71c1c; color: white; padding: 15px;
            font-size: 18px; font-weight: bold; display: flex; justify-content: space-between;
        }
        .rank-list { padding: 10px; overflow-y: auto; text-align: left; }
        .rank-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 5px; border-bottom: 1px solid #eee; font-size: 14px;
        }
        .rank-item:last-child { border-bottom: none; }
        .rank-badge {
            background: #eee; padding: 2px 6px; border-radius: 4px; 
            font-size: 10px; color: #666; margin-left: 5px;
        }
        .rank-line-count { color: #d32f2f; font-weight: bold; }
        .close-rank { cursor: pointer; font-size: 20px; }

        #winner-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(183, 28, 28, 0.95); color: white; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            animation: fadeIn 0.5s;
        }
        #winner-overlay h2 { font-size: 3.5em; margin: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #winner-overlay p { font-size: 1.2em; margin-top: 10px; opacity: 0.9; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ç‰ˆæ¬Š Footer (æ¥µç°¡åŒ–è™•ç†) */
        .system-footer {
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 9px;
            color: rgba(0, 0, 0, 0.2); /* éå¸¸æ·¡çš„é¡è‰²ï¼Œä¸æ¶çœ¼ */
            line-height: 1.6;
        }
        .system-footer strong { color: rgba(0, 0, 0, 0.3); }
    </style>
</head>
<body>

    <button class="rank-btn" onclick="openRank()">ğŸ† æˆ°ç¸¾æ¦œ</button>

    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" width="24" style="margin-bottom:5px; opacity: 0.8;">
    <h1 id="event-title">æ´»å‹•æ¨™é¡Œè¼‰å…¥ä¸­</h1>
    
    <div class="sub-title">
        <span id="event-subtitle">...</span><br>
        <span id="user-name" class="user-greeting">è®€å–ä¸­...</span> 
    </div>

    <div class="grid" id="bingo-grid"></div>

    <div class="system-footer">
        Powered by <strong id="system-author">...</strong><br>
        System &copy; 2026 <span id="system-name">...</span>. All Rights Reserved.
    </div>

    <div class="bottom-bar">
        <div class="status-text" id="status-text">
            ğŸ“ GPS å¾…å‘½<br>
            <span style="font-size:9px; color:#999;">ç²¾æº–åº¦éœ€æ±‚: ä¾åœ°é»</span>
        </div>
        <button class="btn" onclick="checkLocation()">ğŸ“ æ‰“å¡éµ</button>
    </div>
    
    <div class="version-tag">v2026.01.23 Release</div>
    
    <div id="rank-overlay"><div class="rank-box"><div class="rank-header"><span>ğŸ† å¯¦æ™‚æˆ°ç¸¾æ¦œ</span><span class="close-rank" onclick="document.getElementById('rank-overlay').style.display='none'">âœ•</span></div><div class="rank-list" id="rank-content"><p style="text-align:center; color:#999; margin-top:20px;">è¼‰å…¥ä¸­...</p></div></div></div>
    <div id="winner-overlay"><h2>BINGO!</h2><p>å¤ªå¼·äº†ï¼æ­å–œå®ŒæˆæŒ‘æˆ°</p><br><br><button class="btn" style="background: white; color: #b71c1c;" onclick="document.getElementById('winner-overlay').style.display='none'">æª¢è¦–æˆ°ç¸¾</button></div>

<script>
    /**
     * =================================================================
     * ğŸ—ï¸ ç³»çµ±è¨­å®šå€ (System Config)
     * =================================================================
     */
    const SYSTEM_CONFIG = {
        // [è³‡ç”¢å®£å‘Š]
        authorName: "JUILING CHANG / CareLens",   
        systemName: "GoBingo Engine",    
        
        // [æ´»å‹•è³‡è¨Š]
        eventTitle: "æ”¿å¤§EMBAå–®è»Šç¤¾",
        eventSubtitle: "2026 è³“æœé€£ç·šæŒ‘æˆ°",

        // [ç³»çµ±é€£ç·š]
        // è«‹ç¢ºèªé€™è£¡å¡«å…¥çš„æ˜¯æ­£ç¢ºçš„ LIFF ID (From LINE Developers Console)
        liffId: "2008939051-CMBzqbtq",
        // è«‹ç¢ºèªé€™è£¡å¡«å…¥çš„æ˜¯æ­£ç¢ºçš„ Google Apps Script éƒ¨ç½²ç¶²å€
        googleScriptUrl: "https://script.google.com/macros/s/AKfycbxC51dEy8oKWhWnxOYS4GN6_ZYbqXNejhnS6yg1Wva2cA8CAQSta42Vz1dcTZLN0NhCHA/exec"
    };

    // 25 å€‹åœ°é»è¨­å®š
    const locations = [
        { id: 1, region: "å¤§ç¨»åŸ•", name: "è²¨æ«ƒå¸‚é›†", lat: 25.0575, lng: 121.5078, icon: "â›µ", radius: 0.8 },
        { id: 2, region: "æ·±å‘", name: "å¤§èŒ„å†¬æ¨¹", lat: 25.0017, lng: 121.6147, icon: "ğŸŒ³" },
        { id: 3, region: "çŸ³ç¢‡", name: "æµ·å€«å’–å•¡", lat: 24.9634, lng: 121.6247, icon: "â˜•", radius: 0.3 },
        { id: 4, region: "æ·¡æ°´", name: "é¦¬å•ä¸Šå²¸è™•", lat: 25.1717, lng: 121.4404, icon: "â›ª" },
        { id: 5, region: "è¬è¯", name: "é¦¬å ´ç”ºå…¬åœ’", lat: 25.0207, lng: 121.5032, icon: "ğŸŒ³", radius: 1.0 },
        { id: 6, region: "å…«é‡Œ", name: "å»–æ·»ä¸å»Ÿ", lat: 25.1472, lng: 121.3985, icon: "â›©ï¸" },
        { id: 7, region: "é«˜é›„", name: "å±å±±åœ‹å°", lat: 22.6895, lng: 120.3092, icon: "ğŸ«" },
        { id: 8, region: "æœ¨æŸµ", name: "å‹•ç‰©åœ’", lat: 24.9986, lng: 121.5812, icon: "ğŸ¼", radius: 1.0 },
        { id: 9, region: "è²“ç©º", name: "æ˜å¾·å®®", lat: 24.9658, lng: 121.5885, icon: "â›©ï¸" },
        { id: 10, region: "é¶¯æ­Œ", name: "é™¶ç“·åšç‰©é¤¨", lat: 24.9496, lng: 121.3537, icon: "ğŸº" },
        { id: 11, region: "æ–°åº—", name: "ç¢§æ½­åŠæ©‹", lat: 24.9546, lng: 121.5363, icon: "ğŸŒ‰" },
        { id: 12, region: "ç¦å±±", name: "é¦¬å²¸é¤å»³", lat: 24.7746, lng: 121.5007, icon: "ğŸ¥¢" },
        { id: 13, region: "å±æ±", name: "å£½å¡éµé¦¬é©›ç«™", lat: 22.2427, lng: 120.8561, icon: "ğŸ‘‘" }, 
        { id: 14, region: "ç¤¾å­å³¶", name: "å³¶é ­å…¬åœ’", lat: 25.1097, lng: 121.4638, icon: "ğŸŒŠ", radius: 1.0 },
        { id: 15, region: "è²“ç©º", name: "çºœè»Šçµ‚é»ç«™", lat: 24.9687, lng: 121.5886, icon: "ğŸš¡" },
        { id: 16, region: "ä¸‰å³½", name: "æ¸…æ°´ç¥–å¸«å»Ÿ", lat: 24.9338, lng: 121.3703, icon: "â›©ï¸" },
        { id: 17, region: "å£«æ—", name: "ä¸­ç¤¾è·¯é ‚", lat: 25.1031, lng: 121.5583, icon: "ğŸšŒ" },
        { id: 18, region: "çƒä¾†", name: "çƒä¾†ç€‘å¸ƒ", lat: 24.8490, lng: 121.5513, icon: "ğŸŒŠ" },
        { id: 19, region: "å…§æ¹–", name: "åŠå—è·¯é ‚", lat: 25.0932, lng: 121.5552, icon: "ğŸ¦‹" },
        { id: 20, region: "é¶¯æ­Œ", name: "é¾çª¯æ©‹", lat: 24.9537, lng: 121.3532, icon: "ğŸ‰" },
        { id: 21, region: "è¬é‡Œ", name: "é¢¨æ«ƒå˜´æ¶¼äº­", lat: 25.1352, lng: 121.6026, icon: "â›°ï¸" },
        { id: 22, region: "ä¸­æ­£", name: "è¯å±± Allycat's", lat: 25.0441, lng: 121.5294, icon: "ğŸ•", radius: 0.3 },
        { id: 23, region: "é—œæ¸¡", name: "é—œæ¸¡å®®", lat: 25.1192, lng: 121.4673, icon: "ğŸ™" },
        { id: 24, region: "æ–‡å±±", name: "æ”¿æ²»å¤§å­¸", lat: 24.9868, lng: 121.5762, icon: "ğŸ“", radius: 1.0 },
        { id: 25, region: "æ¨¹æ—", name: "å±±ä½³ç«è»Šç«™", lat: 24.9734, lng: 121.3978, icon: "ğŸš‚" }
    ];

    let savedState = JSON.parse(localStorage.getItem('bingoState_nccu_2026')) || [];
    let visitCounts = JSON.parse(localStorage.getItem('bingoCounts_nccu_2026')) || {};
    let clickCounts = {};

    function applyConfig() {
        document.title = SYSTEM_CONFIG.eventTitle;
        document.getElementById('event-title').innerText = SYSTEM_CONFIG.eventTitle;
        document.getElementById('event-subtitle').innerText = SYSTEM_CONFIG.eventSubtitle;
        document.getElementById('system-author').innerText = SYSTEM_CONFIG.authorName;
        document.getElementById('system-name').innerText = SYSTEM_CONFIG.systemName;
    }

    function init() {
        applyConfig();
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = "";
        locations.forEach(loc => {
            let cell = document.createElement('div');
            const isActive = savedState.includes(loc.id);
            const count = visitCounts[loc.id] || 0;
            
            cell.className = 'cell ' + (isActive ? 'active' : '');
            const badgeHtml = count > 0 ? `<div class="count-badge">x${count}</div>` : '';
            const debugHtml = `<div class="debug-click-indicator" id="debug-${loc.id}"></div>`;

            cell.innerHTML = `
                ${debugHtml}
                <div class="region">${loc.region}</div><div class="icon">${loc.icon}</div>
                <div class="name">${loc.name}</div>${badgeHtml}
            `;
            
            // éš±è—çš„ Debug åŠŸèƒ½ (é€£é» 5 ä¸‹) - åƒ…ä¿ç•™é‚è¼¯ï¼Œç§»é™¤å…¬é–‹æ–‡å­—èªªæ˜
            cell.onclick = () => {
                clickCounts[loc.id] = (clickCounts[loc.id] || 0) + 1;
                document.getElementById(`debug-${loc.id}`).style.display = 'block';
                if(clickCounts[loc.id] >= 5) {
                    if(visitCounts[loc.id] > 0) {
                         if(confirm(`ğŸ“ ${loc.name}\nç›®å‰æ¬¡æ•¸ï¼š${visitCounts[loc.id]}\n\næŒ‰ã€Œç¢ºå®šã€ = æ­¸é›¶ (ç§»é™¤è³‡æ–™)\næŒ‰ã€Œå–æ¶ˆã€ = å¢åŠ æ¬¡æ•¸ (+1)`)) {
                             visitCounts[loc.id] = 0; savedState = savedState.filter(x => x !== loc.id); saveAndReload(true); 
                         } else { markVisited(loc.id, true); }
                    } else { markVisited(loc.id, true); }
                    clickCounts[loc.id] = 0; 
                }
                setTimeout(()=> document.getElementById(`debug-${loc.id}`).style.display = 'none', 1000);
            };
            grid.appendChild(cell);
        });
        checkBingo();
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šé›²ç«¯é›™å‘åŒæ­¥ (Cloud Sync)
    function loadUserDataFromCloud(userId) {
        const statusDiv = document.getElementById('status-text');
        statusDiv.innerHTML = "â˜ï¸ è®€å–é›²ç«¯ç´€éŒ„...";
        
        fetch(SYSTEM_CONFIG.googleScriptUrl + "?userId=" + userId)
        .then(response => response.json())
        .then(data => {
            if (data.visitedIds) {
                const cloudVisited = data.visitedIds.toString().split(',').map(Number).filter(n => n > 0);
                // ç°¡å–®åŒæ­¥é‚è¼¯ï¼šè‹¥é›²ç«¯è³‡æ–™è¼ƒå¤šï¼Œå‰‡è¦†è“‹æœ¬åœ°
                if (cloudVisited.length > savedState.length) {
                    savedState = cloudVisited;
                    cloudVisited.forEach(id => {
                        if (!visitCounts[id]) visitCounts[id] = 1;
                    });
                    
                    localStorage.setItem('bingoState_nccu_2026', JSON.stringify(savedState));
                    localStorage.setItem('bingoCounts_nccu_2026', JSON.stringify(visitCounts));
                    init(); 
                    console.log("Synced from cloud:", savedState);
                }
            }
            statusDiv.innerHTML = "âœ… åŒæ­¥å®Œæˆ";
            setTimeout(() => { statusDiv.innerHTML = "ğŸ“ GPS å¾…å‘½"; }, 2000);
        })
        .catch(err => {
            console.error("Cloud sync failed", err);
            statusDiv.innerHTML = "âš ï¸ é›¢ç·šæ¨¡å¼";
        });
    }

    function markVisited(id, isManual) {
        visitCounts[id] = (visitCounts[id] || 0) + 1;
        if (!savedState.includes(id)) savedState.push(id);
        saveAndReload(false, isManual ? null : id);
    }
    
    function saveAndReload(isRemove, alertId) {
        localStorage.setItem('bingoState_nccu_2026', JSON.stringify(savedState));
        localStorage.setItem('bingoCounts_nccu_2026', JSON.stringify(visitCounts));
        init();
        if(alertId) {
            const locName = locations.find(x=>x.id===alertId).name;
            const currentCount = visitCounts[alertId];
            alert(`ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${locName}\n(ç›®å‰ç´¯ç©: ${currentCount} æ¬¡)`);
        }
        syncToGoogleSheet();
    }

    function checkLocation() {
        const statusText = document.getElementById('status-text');
        statusText.innerHTML = "ğŸ›°ï¸ è¡›æ˜Ÿå®šä½ä¸­...";
        if (!navigator.geolocation) { alert("éŒ¯èª¤ï¼šä½ çš„è£ç½®ä¸æ”¯æ´ GPS"); return; }
        navigator.geolocation.getCurrentPosition(position => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            let foundCount = 0;
            statusText.innerHTML = `ğŸ“ ç¶“:${userLng.toFixed(3)} ç·¯:${userLat.toFixed(3)}<br><span style='font-size:9px'>èª¤å·®ç¯„åœ: ä¾åœ°é»</span>`;
            locations.forEach(loc => {
                const targetRadius = loc.radius || 0.5; 
                const dist = getDistanceFromLatLonInKm(userLat, userLng, loc.lat, loc.lng);
                if (dist < targetRadius) { markVisited(loc.id, false); foundCount++; }
            });
            if(foundCount === 0) alert("âŒ æ‰“å¡å¤±æ•—\né™„è¿‘æ²’æœ‰è³“æœé» (è«‹ç¢ºèªæ˜¯å¦åœ¨èª¤å·®ç¯„åœå…§)\nå†é è¿‘ä¸€é»è©¦è©¦çœ‹ï¼");
        }, error => {
            statusText.innerHTML = "âŒ å®šä½å¤±æ•—<br><span style='font-size:9px'>è«‹æª¢æŸ¥ GPS æ¬Šé™</span>";
            alert("è«‹å…è¨±ç¶²é ä½¿ç”¨ä½ç½®æ¬Šé™ï¼Œä¸¦ç¢ºèªæ‰‹æ©Ÿ GPS å·²é–‹å•Ÿã€‚");
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }

    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function checkBingo() {
        const lines = [ [1,2,3,4,5], [6,7,8,9,10], [11,12,13,14,15], [16,17,18,19,20], [21,22,23,24,25], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [5,10,15,20,25], [1,7,13,19,25], [5,9,13,17,21] ];
        let winCount = 0;
        lines.forEach(line => { if (line.every(id => savedState.includes(id))) winCount++; });
        if (winCount >= 5) document.getElementById('winner-overlay').style.display = 'flex';
        else document.getElementById('winner-overlay').style.display = 'none';
        return winCount;
    }

    function syncToGoogleSheet() {
        const statusDiv = document.getElementById('status-text');
        if (!liff.isLoggedIn()) { statusDiv.innerHTML = "âš ï¸ æœªç™»å…¥"; return; }
        statusDiv.innerHTML = "â˜ï¸ é›²ç«¯åŒæ­¥ä¸­...";
        liff.getProfile().then(profile => {
            const payload = {
                userId: profile.userId,
                name: profile.displayName,
                points: savedState.length,
                lines: checkBingo(),
                visitedIds: savedState,
                visitedCounts: visitCounts
            };
            fetch(SYSTEM_CONFIG.googleScriptUrl, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                statusDiv.innerHTML = "âœ… è³‡æ–™å·²å­˜æª”";
                setTimeout(() => { if(!statusDiv.innerHTML.includes('ç¶“:')) statusDiv.innerHTML = "ğŸ“ GPS å¾…å‘½"; }, 2000);
            });
        });
    }

    function openRank() {
        document.getElementById('rank-overlay').style.display = 'flex';
        const listDiv = document.getElementById('rank-content');
        listDiv.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px;">è¼‰å…¥ä¸­...</p>';
        fetch(SYSTEM_CONFIG.googleScriptUrl)
        .then(response => response.json())
        .then(data => {
            let html = "";
            if(data.length === 0) {
                html = '<p style="text-align:center;margin-top:20px;">ç„¡è³‡æ–™</p>';
            } else {
                data.forEach((user, index) => {
                    let visitedNames = [];
                    if(user.visited) {
                        const ids = user.visited.toString().split(',');
                        visitedNames = ids.slice(0, 3).map(id => {
                            const loc = locations.find(l => l.id == id);
                            return loc ? loc.name : id;
                        });
                        if(ids.length > 3) visitedNames.push(`...ç­‰${ids.length}è™•`);
                    }
                    const visitedStr = visitedNames.length > 0 ? visitedNames.join('ã€') : 'å°šæœªå‡ºç™¼';
                    html += `<div class="rank-item"><div><strong>${index+1}. ${user.name}</strong><br><span style="font-size:10px; color:#888;">${visitedStr}</span></div><div style="text-align:right;"><div class="rank-line-count">${user.lines} é€£ç·š</div><span class="rank-badge">${user.points} æ ¼</span></div></div>`;
                });
            }
            listDiv.innerHTML = html;
        });
    }

    async function main() {
        try {
            await liff.init({ liffId: SYSTEM_CONFIG.liffId });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = `Hi, ${profile.displayName}`;
                
                // ç™»å…¥å¾ŒåŸ·è¡ŒåŒæ­¥
                loadUserDataFromCloud(profile.userId);
                
            } else {
                document.getElementById('user-name').innerText = " (è¨ªå®¢æ¨¡å¼)";
                liff.login();
            }
        } catch (err) {
            document.getElementById('user-name').innerText = " (ç³»çµ±éŒ¯èª¤)";
            console.error(err);
        }
        init();
    }
    main();
</script>
</body>
</html>
