<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bingo è¨ºæ–·æ¨¡å¼</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: sans-serif; background: #fdf5e6; text-align: center; 
            margin: 0; padding: 0 0 100px 0; min-height: 100vh; 
        }

        /* --- é»‘è‰²é™¤éŒ¯è¦–çª— (è¨ºæ–·ç”¨) --- */
        #debug-console {
            background: #000; color: #0f0; font-family: monospace; font-size: 10px;
            text-align: left; padding: 10px; margin-bottom: 10px;
            height: 120px; overflow-y: scroll; border-bottom: 2px solid #333;
        }

        h1 { color: #b71c1c; margin: 5px 0; font-size: 1.5em; }
        .grid-container { display: flex; justify-content: center; padding: 10px; }
        .grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; 
            width: 100%; max-width: 450px; aspect-ratio: 1/1; 
        }
        .cell { 
            background: white; border: 1px solid #b71c1c; border-radius: 4px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; position: relative;
        }
        .cell.active { background: #b71c1c; color: white; }
        .name { font-size: 10px; font-weight: bold; line-height: 1.2; width: 95%; overflow: hidden; height: 12px; }
        .icon { font-size: 16px; }

        /* --- åº•éƒ¨æŒ‰éˆ• --- */
        .bottom-bar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: white; padding: 10px 20px; border-radius: 30px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; gap: 10px; z-index: 100;
        }
        .btn { background: #b71c1c; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="debug-console">System Init...<br></div>

    <h1 id="user-name">è¨ªå®¢</h1>
    
    <div class="grid-container">
        <div class="grid" id="bingo-grid"></div>
    </div>

    <div class="bottom-bar">
        <button class="btn" onclick="checkLocation()">ğŸ“ æ‰“å¡</button>
        <button class="btn" style="background:#444;" onclick="window.location.reload()">ğŸ”„ é‡æ•´</button>
    </div>

<script>
    // âš ï¸ è«‹ç¢ºèªæ‚¨çš„ GAS ç¶²å€ (å¿…é ˆä»¥ /exec çµå°¾)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxC51dEy8oKWhWnxOYS4GN6_ZYbqXNejhnS6yg1Wva2cA8CAQSta42Vz1dcTZLN0NhCHA/exec";
    const LIFF_ID = "2008939051-CMBzqbtq";

    const locations = [
       { id: 1, name: "å¤§ç¨»åŸ•è²¨æ«ƒ", lat: 25.0575, lng: 121.5078, icon: "â›µ" },
       { id: 2, name: "æœˆçœ‰æ¿•åœ°", lat: 24.8968, lng: 121.2961, icon: "ğŸŒ³" },
       { id: 3, name: "æµ·å€«å’–å•¡", lat: 24.9634, lng: 121.6247, icon: "â˜•" },
       { id: 4, name: "é™¶ç“·åšç‰©é¤¨", lat: 24.9496, lng: 121.3537, icon: "ğŸº" },
       { id: 5, name: "é¦¬å ´ç”º", lat: 25.0207, lng: 121.5032, icon: "ğŸŒ³" },
       { id: 6, name: "å»–æ·»ä¸å»Ÿ", lat: 25.1472, lng: 121.3985, icon: "â›©ï¸" },
       { id: 7, name: "å±å±±åœ‹å°", lat: 22.6895, lng: 120.3092, icon: "ğŸ«" },
       { id: 8, name: "é¢¨æ«ƒå˜´", lat: 25.1352, lng: 121.6026, icon: "â›°ï¸" },
       { id: 9, name: "å¹³æºªè±†èŠ±", lat: 25.0257, lng: 121.7394, icon: "ğŸ§" },
       { id: 10, name: "è§’æ¿å±±", lat: 24.8161, lng: 121.3513, icon: "â›°ï¸" },
       { id: 11, name: "ç¢§æ½­åŠæ©‹", lat: 24.9546, lng: 121.5363, icon: "ğŸŒ‰" },
       { id: 12, name: "ç¦å±±é¦¬å®¶å ¡", lat: 24.7746, lng: 121.5007, icon: "ğŸ¥¢" },
       { id: 13, name: "å£½å¡é©›ç«™", lat: 22.2427, lng: 120.8561, icon: "ğŸ‘‘" },
       { id: 14, name: "æ±çœ¼å±±", lat: 24.8313, lng: 121.4079, icon: "ğŸŒ²" },
       { id: 15, name: "è²“ç©ºçºœè»Š", lat: 24.9687, lng: 121.5886, icon: "ğŸš¡" },
       { id: 16, name: "é¦¬å•ä¸Šå²¸", lat: 25.1717, lng: 121.4404, icon: "â›ª" },
       { id: 17, name: "ä¸­ç¤¾è·¯", lat: 25.1031, lng: 121.5583, icon: "ğŸšŒ" },
       { id: 18, name: "äºŒå­åª", lat: 25.1856, lng: 121.5247, icon: "ğŸ¦‹" },
       { id: 19, name: "åŠå—è·¯", lat: 25.0932, lng: 121.5552, icon: "ğŸ¦‹" },
       { id: 20, name: "è§€éŸ³å±±", lat: 25.1325, lng: 121.4243, icon: "â›°ï¸" },
       { id: 21, name: "åªæ—è€è¡—", lat: 24.9357, lng: 121.7118, icon: "ğŸµ" },
       { id: 22, name: "æ»¿æœˆåœ“", lat: 24.8346, lng: 121.4428, icon: "ğŸŒ²" },
       { id: 23, name: "é—œæ¸¡å®®", lat: 25.1192, lng: 121.4673, icon: "ğŸ™" },
       { id: 24, name: "çƒä¾†ç€‘å¸ƒ", lat: 24.8490, lng: 121.5513, icon: "ğŸŒŠ" },
       { id: 25, name: "å¾©èˆˆç©ºå»š", lat: 25.0560, lng: 121.2480, icon: "ğŸ" }
    ];

    let myVisitedIds = [];
    let clickCounts = {};

    // è¢å¹•æ—¥èªŒåŠŸèƒ½
    function log(msg) {
        const consoleDiv = document.getElementById('debug-console');
        const time = new Date().toTimeString().split(' ')[0];
        consoleDiv.innerHTML += `[${time}] ${msg}<br>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        console.log(msg);
    }

    // åˆå§‹åŒ–æµç¨‹
    async function main() {
        log("1. é–‹å§‹ renderGrid (æœ¬åœ°)");
        renderGrid(); // å…ˆç•«æ ¼å­ï¼Œç¢ºä¿ç•«é¢æœ‰æ±è¥¿

        try {
            log("2. æ­£åœ¨åˆå§‹åŒ– LIFF...");
            await liff.init({ liffId: LIFF_ID });
            log("âœ… LIFF åˆå§‹åŒ–æˆåŠŸ");

            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = profile.displayName;
                log(`3. å–å¾—ä½¿ç”¨è€…: ${profile.displayName}`);
                log(`   ID: ${profile.userId.substring(0,5)}...`);
                
                // é–‹å§‹åŒæ­¥
                await syncCloud(profile.userId);
            } else {
                log("âš ï¸ æœªç™»å…¥ï¼Œè½‰å€ä¸­...");
                liff.login();
            }
        } catch (err) {
            log(`âŒ éŒ¯èª¤: ${err.message}`);
            log("âš ï¸ è«‹æª¢æŸ¥ LIFF ID æˆ–ç¶²è·¯");
        }
    }

    // é›²ç«¯åŒæ­¥ (ä½¿ç”¨ fetch)
    async function syncCloud(userId) {
        log("4. é–‹å§‹é€£ç·š Google (GAS)...");
        const t = new Date().getTime();
        const url = `${GAS_URL}?userId=${userId}&t=${t}`;
        
        try {
            const res = await fetch(url);
            log(`5. æ”¶åˆ°å›æ‡‰ (Status: ${res.status})`);
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            // å˜—è©¦è§£æ JSON
            const text = await res.text(); // å…ˆè®€æˆæ–‡å­—ï¼Œæ€•æ”¶åˆ° HTML éŒ¯èª¤é 
            log(`6. å›å‚³é•·åº¦: ${text.length}`);
            
            try {
                const data = JSON.parse(text);
                log("âœ… JSON è§£ææˆåŠŸ");
                
                if (data.visitedIds) {
                    myVisitedIds = data.visitedIds;
                    log(`7. åŒæ­¥è³‡æ–™: ${myVisitedIds.length} ç­†`);
                    renderGrid(); // é‡ç•«
                } else {
                    log("âš ï¸ JSON æ ¼å¼æ€ªæ€ªçš„: " + JSON.stringify(data).substring(0, 30));
                }
            } catch (jsonErr) {
                log("âŒ JSON è§£æå¤±æ•— (å¯èƒ½æ”¶åˆ° HTML?)");
                log("å…§å®¹ç‰‡æ®µ: " + text.substring(0, 50));
                log("ğŸ‘‰ è«‹æª¢æŸ¥ GAS æ¬Šé™æ˜¯å¦ç‚ºã€Œæ‰€æœ‰äººã€");
            }

        } catch (err) {
            log(`âŒ é€£ç·šå¤±æ•—: ${err.message}`);
        }
    }

    function renderGrid() {
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = "";
        locations.forEach(loc => {
            let cell = document.createElement('div');
            const isActive = myVisitedIds.includes(loc.id);
            cell.className = `cell ${isActive ? 'active' : ''}`;
            cell.innerHTML = `<div class="icon">${loc.icon}</div><div class="name">${loc.name}</div>`;
            
            // Debug é»æ“Š (é€£é»5ä¸‹)
            cell.onclick = () => {
                clickCounts[loc.id] = (clickCounts[loc.id] || 0) + 1;
                if(clickCounts[loc.id] >= 5) {
                    log(`ğŸ› ï¸ å¼·åˆ¶æ‰“å¡: ${loc.name}`);
                    if(!myVisitedIds.includes(loc.id)) myVisitedIds.push(loc.id);
                    renderGrid();
                    clickCounts[loc.id] = 0;
                    // é€™è£¡å¯ä»¥è£œä¸Š save
                    liff.getProfile().then(p => saveToCloud(p.userId));
                }
            };
            grid.appendChild(cell);
        });
    }

    function checkLocation() {
        log("ğŸ›°ï¸ å•Ÿå‹• GPS...");
        if (!navigator.geolocation) { log("âŒ ä¸æ”¯æ´ GPS"); return; }
        
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            log(`ğŸ“ åº§æ¨™: ${lat.toFixed(3)}, ${lng.toFixed(3)}`);
            
            let hit = false;
            locations.forEach(loc => {
                if (getDist(lat, lng, loc.lat, loc.lng) < 0.8) {
                    log(`ğŸ¯ å‘½ä¸­: ${loc.name}`);
                    if (!myVisitedIds.includes(loc.id)) {
                        myVisitedIds.push(loc.id);
                        hit = true;
                    }
                }
            });
            
            if(hit) {
                renderGrid();
                alert("æ‰“å¡æˆåŠŸï¼");
                liff.getProfile().then(p => saveToCloud(p.userId));
            } else {
                alert("é™„è¿‘æ²’æœ‰é» (è«‹çœ‹ä¸Šæ–¹é»‘åº•æ—¥èªŒ)");
            }

        }, err => {
            log(`âŒ GPS éŒ¯èª¤: ${err.message}`);
            alert("å®šä½å¤±æ•—");
        }, { enableHighAccuracy: true });
    }

    function saveToCloud(userId) {
        log("â˜ï¸ ä¸Šå‚³è³‡æ–™ä¸­...");
        fetch(GAS_URL, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: userId, name: document.getElementById('user-name').innerText, visitedIds: myVisitedIds })
        }).then(() => log("âœ… ä¸Šå‚³è«‹æ±‚å·²ç™¼é€"));
    }

    function getDist(lat1,lon1,lat2,lon2) {
        var R = 6371; var dLat = (lat2-lat1)*(Math.PI/180); var dLon = (lon2-lon1)*(Math.PI/180); 
        var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
    }

    // å•Ÿå‹•
    main();

</script>
</body>
</html>
