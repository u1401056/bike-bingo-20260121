// --- ä¿®æ”¹å¾Œçš„ function (æ”¾åœ¨ script æœ€å¾Œé¢) ---

    function loadUserDataFromCloud(userId) {
        // æ³¨æ„ï¼šé€™è£¡ç§»é™¤äº† console.logï¼Œæ”¹æˆèƒŒæ™¯åŸ·è¡Œä¸æ‰“æ“¾
        const statusDiv = document.getElementById('status-text');
        
        fetch(SYSTEM_CONFIG.googleScriptUrl + "?userId=" + userId)
        .then(response => response.json())
        .then(data => {
            // 1. æ›´æ–°èº«åˆ†
            if (data.userRole && data.userRole !== currentUserRole) {
                currentUserRole = data.userRole;
                updateUserStatusUI();
            }

            // 2. æ›´æ–°ç´€éŒ„
            if (data.visitLogs) {
                let cloudLogs = data.visitLogs;
                let hasChange = false;
                for(let locId in cloudLogs) {
                    let localArr = visitLogs[locId] || [];
                    let cloudArr = cloudLogs[locId] || [];
                    let merged = [...new Set([...localArr, ...cloudArr])].sort();
                    if(merged.length > localArr.length) {
                        visitLogs[locId] = merged;
                        hasChange = true;
                    }
                }
                if (hasChange) {
                    localStorage.setItem('bingoLogs_nccu_2026', JSON.stringify(visitLogs));
                    init(); 
                    // åªæœ‰åœ¨çœŸçš„æœ‰æ–°è³‡æ–™é€²ä¾†æ™‚ï¼Œæ‰ç¨å¾®é–ƒçˆä¸€ä¸‹ç‹€æ…‹åˆ—
                    statusDiv.innerHTML = "âœ… è³‡æ–™å·²åŒæ­¥";
                    setTimeout(() => { if(!statusDiv.innerHTML.includes('ç¶“:')) statusDiv.innerHTML = "ğŸ“ GPS å¾…å‘½"; }, 2000);
                }
            }
            isDataLoaded = true;
            // é€™è£¡ä¸éœ€è¦ hideLoadingMask äº†ï¼Œå› ç‚ºæˆ‘å€‘ä¸€é–‹å§‹å°±é—œäº†
        })
        .catch(err => {
            console.error("Background sync failed", err);
            isDataLoaded = true; // å³ä½¿å¤±æ•—ä¹Ÿç•¶ä½œè¼‰å…¥å®Œæˆï¼Œå…è¨±æ‰“å¡
        });
    }

    async function main() {
        // ğŸ”¥ 1. å…ˆæ¸²æŸ“æœ¬åœ°è³‡æ–™ï¼Œè®“ç•«é¢ç§’é–‹
        init(); 
        
        // ğŸ”¥ 2. ç§»é™¤é®ç½© (è®“ä½¿ç”¨è€…è¦ºå¾—å·²ç¶“å¥½äº†)
        const mask = document.getElementById('loading-mask');
        if(mask) mask.style.display = 'none';

        try {
            await liff.init({ liffId: SYSTEM_CONFIG.liffId });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = `Hi, ${profile.displayName}`;
                currentUserId = profile.userId;
                
                // ğŸ”¥ 3. èƒŒæ™¯åŸ·è¡ŒåŒæ­¥ (ä½¿ç”¨è€…ç„¡æ„Ÿ)
                registerAutoSync();
                loadUserDataFromCloud(profile.userId);
            } else {
                document.getElementById('user-name').innerText = " (è¨ªå®¢æ¨¡å¼)";
                liff.login();
            }
        } catch (err) {
            document.getElementById('user-name').innerText = " (ç³»çµ±éŒ¯èª¤)";
            console.error(err);
        }
    }
