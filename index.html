<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ”¿å¤§EMBAå–®è»Šç¤¾è³“æœæŒ‘æˆ°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* åŸºç¤è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; 
            background: #fdf5e6; 
            text-align: center; 
            margin: 0; 
            padding: 20px 10px 100px 10px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        h1 { color: #b71c1c; margin: 10px 0 5px 0; font-size: 1.8em; letter-spacing: 1px; font-weight: 800; }
        .sub-title { color: #666; font-size: 0.95em; margin-bottom: 25px; line-height: 1.5; }
        .user-greeting { color: #b71c1c; font-weight: bold; }

        .grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            max-width: 600px;
            margin: 0 auto;
        }

        .cell {
            aspect-ratio: 1/1; 
            background: white;
            border: 1.5px solid #b71c1c;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        
        .cell:active { transform: scale(0.95); }

        .cell.active {
            background: #b71c1c;
            color: white;
            border-color: #8e1616;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        
        .icon { font-size: 18px; margin-bottom: 2px; line-height: 1; }
        .region { font-size: 10px; color: #888; margin-bottom: 2px; transform: scale(0.9); }
        .cell.active .region { color: #ffcccc; }
        .name { font-weight: bold; line-height: 1.1; font-size: 10px; width: 100%; word-break: break-all; }
        
        @media (max-width: 360px) {
            .name { font-size: 9px; transform: scale(0.95); }
            .icon { font-size: 14px; }
            .grid { gap: 3px; }
        }

        .bottom-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px; border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; gap: 10px; align-items: center; 
            white-space: nowrap; z-index: 100;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .status-text { font-size: 11px; color: #555; text-align: left; line-height: 1.2; margin-right: 5px;}

        .btn { 
            background: linear-gradient(135deg, #d32f2f, #b71c1c); 
            color: white; border: none; padding: 12px 24px; 
            border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 15px; 
            box-shadow: 0 4px 10px rgba(183, 28, 28, 0.3);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        #winner-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(183, 28, 28, 0.95); color: white; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            animation: fadeIn 0.5s;
        }
        #winner-overlay h2 { font-size: 3.5em; margin: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #winner-overlay p { font-size: 1.2em; margin-top: 10px; opacity: 0.9; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999; display:flex; justify-content:center; align-items:center; transition: opacity 0.5s; flex-direction: column;}
        #loading p { margin-top: 10px; color: #999; font-size: 12px; }
    </style>
</head>
<body>

    <div id="loading">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" width="50">
        <p>è¼‰å…¥ä¸­...</p>
    </div>

    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" width="24" style="margin-bottom:5px; opacity: 0.8;">
    <h1>æ”¿å¤§EMBAå–®è»Šç¤¾</h1>
    <div class="sub-title">
        2026 è³“æœé€£ç·šæŒ‘æˆ°<br>
        <span id="user-name" class="user-greeting"></span> 
    </div>

    <div class="grid" id="bingo-grid"></div>

    <div class="bottom-bar">
        <div class="status-text" id="status-text">
            ğŸ“ GPS å¾…å‘½<br>
            <span style="font-size:9px; color:#999;">ç²¾æº–åº¦éœ€æ±‚: 500m</span>
        </div>
        <button class="btn" onclick="checkLocation()">ğŸ“ æ‰“å¡ Check</button>
    </div>
    
    <p style="color:#ccc; font-size:10px; margin-top:40px;">
        Debugæ¨¡å¼ï¼šé»æ“Šæ ¼å­ 5 æ¬¡å¯å¼·åˆ¶äº®ç‡ˆ/å–æ¶ˆ<br>
        è³‡æ–™å°‡è‡ªå‹•åŒæ­¥è‡³é›²ç«¯
    </p>

    <div id="winner-overlay">
        <h2>BINGO!</h2>
        <p>å¤ªå¼·äº†ï¼æ­å–œå®ŒæˆæŒ‘æˆ°</p>
        <br><br>
        <button class="btn" style="background: white; color: #b71c1c;" onclick="closeWinner()">æª¢è¦–æˆ°ç¸¾</button>
    </div>

<script>
    const MY_LIFF_ID = "2008939051-CMBzqbtq";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxC51dEy8oKWhWnxOYS4GN6_ZYbqXNejhnS6yg1Wva2cA8CAQSta42Vz1dcTZLN0NhCHA/exec";

    // å®‰å…¨æ©Ÿåˆ¶ï¼š3ç§’å¾Œå¼·åˆ¶é—œé–‰è¼‰å…¥ç•«é¢
    setTimeout(() => {
        const loader = document.getElementById('loading');
        if(loader && loader.style.display !== 'none') {
            loader.style.opacity = 0;
            setTimeout(() => loader.style.display = 'none', 500);
            console.log("å¼·åˆ¶é—œé–‰è¼‰å…¥é®ç½©");
        }
    }, 3000);

    // 25 å€‹åœ°é»è³‡æ–™ (å·²ä¿®æ”¹ï¼šæ”¿å¤§ã€æ¸…å¢ƒã€è¯å±±Allycat's)
    const locations = [
        // --- ç¬¬ä¸€æ’ ---
        { id: 1, region: "å¤§ç¨»åŸ•", name: "è²¨æ«ƒå¸‚é›†", lat: 25.0575, lng: 121.5078, icon: "â›µ" },
        { id: 2, region: "ç¤¾å­å³¶", name: "å³¶é ­å…¬åœ’", lat: 25.1097, lng: 121.4638, icon: "ğŸŒŠ" },
        { id: 3, region: "é—œæ¸¡", name: "é—œæ¸¡å®®", lat: 25.1192, lng: 121.4673, icon: "ğŸ™" },
        { id: 4, region: "æ·¡æ°´", name: "é¦¬å•ä¸Šå²¸è™•", lat: 25.1717, lng: 121.4404, icon: "â›ª" },
        { id: 5, region: "å…«é‡Œ", name: "å·¦å²¸å…¬åœ’", lat: 25.1614, lng: 121.4335, icon: "ğŸš²" },

        // --- ç¬¬äºŒæ’ ---
        { id: 6, region: "å…«é‡Œ", name: "å»–æ·»ä¸å»Ÿ", lat: 25.1472, lng: 121.3985, icon: "â›©ï¸" },
        { id: 7, region: "æ–°æœˆæ©‹", name: "é€æ˜æ­¥é“", lat: 25.0348, lng: 121.4506, icon: "ğŸŒ‰" },
        { id: 8, region: "æ¨¹æ—", name: "å±±ä½³ç«è»Šç«™", lat: 24.9734, lng: 121.3978, icon: "ğŸš‚" },
        { id: 9, region: "é¶¯æ­Œ", name: "é¾çª¯æ©‹", lat: 24.9537, lng: 121.3532, icon: "ğŸ‰" },
        { id: 10, region: "é¶¯æ­Œ", name: "é™¶ç“·åšç‰©é¤¨", lat: 24.9496, lng: 121.3537, icon: "ğŸº" },

        // --- ç¬¬ä¸‰æ’ (å·²ä¿®æ”¹ ID 11) ---
        { id: 11, region: "æ–‡å±±", name: "æ”¿æ²»å¤§å­¸", lat: 24.9868, lng: 121.5762, icon: "ğŸ“" }, // æ”¹ç‚ºæ”¿å¤§
        { id: 12, region: "æœ¨æŸµ", name: "å‹•ç‰©åœ’", lat: 24.9986, lng: 121.5812, icon: "ğŸ¼" },
        { id: 13, region: "æ·±å‘", name: "å¤§èŒ„å†¬æ¨¹", lat: 25.0017, lng: 121.6147, icon: "ğŸŒ³" },
        { id: 14, region: "è²“ç©º", name: "æ˜å¾·å®®", lat: 24.9658, lng: 121.5885, icon: "â›©ï¸" },
        { id: 15, region: "è²“ç©º", name: "çºœè»Šçµ‚é»ç«™", lat: 24.9687, lng: 121.5886, icon: "ğŸš¡" },

        // --- ç¬¬å››æ’ ---
        { id: 16, region: "ä¸‰å³½", name: "æ¸…æ°´ç¥–å¸«å»Ÿ", lat: 24.9338, lng: 121.3703, icon: "â›©ï¸" },
        { id: 17, region: "æ–°åº—", name: "ç¢§æ½­åŠæ©‹", lat: 24.9546, lng: 121.5363, icon: "ğŸŒ‰" },
        { id: 18, region: "å£«æ—", name: "ä¸­ç¤¾è·¯é ‚", lat: 25.1031, lng: 121.5583, icon: "ğŸšŒ" },
        { id: 19, region: "å…§æ¹–", name: "åŠå—è·¯é ‚", lat: 25.0932, lng: 121.5552, icon: "ğŸ¦‹" },
        { id: 20, region: "è¬é‡Œ", name: "é¢¨æ«ƒå˜´æ¶¼äº­", lat: 25.1352, lng: 121.6026, icon: "â›°ï¸" },

        // --- ç¬¬äº”æ’ (å·²ä¿®æ”¹ ID 24, 25) ---
        { id: 21, region: "çŸ³ç¢‡", name: "æµ·å€«å’–å•¡", lat: 24.9634, lng: 121.6247, icon: "â˜•" },
        { id: 22, region: "çƒä¾†", name: "çƒä¾†ç€‘å¸ƒ", lat: 24.8490, lng: 121.5513, icon: "ğŸŒŠ" },
        { id: 23, region: "ç¦å±±", name: "é¦¬å²¸é¤å»³", lat: 24.7746, lng: 121.5007, icon: "ğŸ¥¢" },
        // é¡¯ç¤ºåå±å±±ï¼Œåº§æ¨™æ”¿å¤§æ¸…å¢ƒ
        { id: 24, region: "é«˜é›„(?)", name: "å±å±±åœ‹å°", lat: 24.9825, lng: 121.5785, icon: "ğŸ«" }, 
        // é¡¯ç¤ºåAllycat'sï¼Œåº§æ¨™è¯å±±
        { id: 25, region: "ä¸­æ­£", name: "è¯å±± Allycat's", lat: 25.0441, lng: 121.5294, icon: "ğŸ•" } 
    ];

    let savedState = JSON.parse(localStorage.getItem('bingoState_nccu_2026')) || [];
    const grid = document.getElementById('bingo-grid');
    const statusText = document.getElementById('status-text');
    let clickCounts = {};

    function init() {
        grid.innerHTML = "";
        locations.forEach(loc => {
            let cell = document.createElement('div');
            const isActive = savedState.includes(loc.id);
            cell.className = 'cell ' + (isActive ? 'active' : '');
            cell.innerHTML = `
                <div class="region">${loc.region}</div>
                <div class="icon">${loc.icon}</div>
                <div class="name">${loc.name}</div>
            `;
            
            cell.onclick = () => {
                clickCounts[loc.id] = (clickCounts[loc.id] || 0) + 1;
                
                if(clickCounts[loc.id] >= 5) {
                    if (isActive) {
                        savedState = savedState.filter(id => id !== loc.id);
                        alert(`âŒ å·²å–æ¶ˆï¼š${loc.name}`);
                    } else {
                        savedState.push(loc.id);
                        alert(`ğŸ‰ å¼·åˆ¶æ‰“å¡ï¼š${loc.name}`);
                    }
                    localStorage.setItem('bingoState_nccu_2026', JSON.stringify(savedState));
                    clickCounts[loc.id] = 0; 
                    init();
                    syncToGoogleSheet();
                }
            };
            grid.appendChild(cell);
        });
        checkBingo();
        document.getElementById('loading').style.opacity = 0;
        setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
    }

    function markVisited(id, isManual) {
        if (!savedState.includes(id)) {
            savedState.push(id);
            localStorage.setItem('bingoState_nccu_2026', JSON.stringify(savedState));
            init();
            if(!isManual) {
                const locName = locations.find(x=>x.id===id).name;
                alert(`ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${locName}`);
            }
            syncToGoogleSheet();
        }
    }

    function checkLocation() {
        statusText.innerHTML = "ğŸ›°ï¸ è¡›æ˜Ÿå®šä½ä¸­...<br><span style='font-size:9px'>è«‹ä¿æŒåœ¨å®¤å¤–</span>";
        if (!navigator.geolocation) {
            alert("éŒ¯èª¤ï¼šä½ çš„è£ç½®ä¸æ”¯æ´ GPS");
            return;
        }
        navigator.geolocation.getCurrentPosition(position => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            let found = false;

            statusText.innerHTML = `ğŸ“ ç¶“:${userLng.toFixed(3)} ç·¯:${userLat.toFixed(3)}<br><span style='font-size:9px'>èª¤å·®ç¯„åœ: 500m</span>`;

            locations.forEach(loc => {
                if(savedState.includes(loc.id)) return;
                
                const dist = getDistanceFromLatLonInKm(userLat, userLng, loc.lat, loc.lng);
                if (dist < 0.5) { 
                    markVisited(loc.id, false);
                    found = true;
                }
            });

            if(!found) {
                alert("âŒ æ‰“å¡å¤±æ•—\né™„è¿‘æ²’æœ‰è³“æœé» (èª¤å·®ç¯„åœ 500m)\nå†é è¿‘ä¸€é»è©¦è©¦çœ‹ï¼");
            }
        }, error => {
            statusText.innerHTML = "âŒ å®šä½å¤±æ•—<br><span style='font-size:9px'>è«‹æª¢æŸ¥ GPS æ¬Šé™</span>";
            alert("è«‹å…è¨±ç¶²é ä½¿ç”¨ä½ç½®æ¬Šé™ï¼Œä¸¦ç¢ºèªæ‰‹æ©Ÿ GPS å·²é–‹å•Ÿã€‚");
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }

    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; 
        var dLat = deg2rad(lat2-lat1); 
        var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function checkBingo() {
        const lines = [
            [1,2,3,4,5], [6,7,8,9,10], [11,12,13,14,15], [16,17,18,19,20], [21,22,23,24,25], 
            [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [5,10,15,20,25], 
            [1,7,13,19,25], [5,9,13,17,21] 
        ];
        let winCount = 0;
        lines.forEach(line => {
            if (line.every(id => savedState.includes(id))) winCount++;
        });

        if (winCount >= 5) {
            document.getElementById('winner-overlay').style.display = 'flex';
        } else {
            document.getElementById('winner-overlay').style.display = 'none';
        }
        return winCount;
    }
    function closeWinner() { document.getElementById('winner-overlay').style.display = 'none'; }

    function syncToGoogleSheet() {
        if (!liff.isLoggedIn()) return;
        liff.getProfile().then(profile => {
            const payload = {
                userId: profile.userId,
                name: profile.displayName,
                points: savedState.length,
                lines: checkBingo(),
                visitedIds: savedState
            };
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(console.error);
        });
    }

    async function main() {
        try {
            await liff.init({ liffId: MY_LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = `Hi, ${profile.displayName}`;
            }
        } catch (err) {
            console.error(err);
        }
        init();
    }
    main();
</script>
</body>
</html>
