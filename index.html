<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>æ´»å‹•è¼‰å…¥ä¸­...</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- Reset & Layout Fixes --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; 
            background: #fdf5e6; 
            text-align: center; 
            margin: 0; 
            padding: 20px 0 100px 0; /* å·¦å³ padding æ­¸é›¶ï¼Œäº¤çµ¦å…§éƒ¨å®¹å™¨æ§åˆ¶ */
            min-height: 100vh;
            overflow-x: hidden; /* é˜²æ­¢æ©«å‘å·è»¸ */
        }
        
        h1 { color: #b71c1c; margin: 10px 0 5px 0; font-size: 1.6em; font-weight: 800; }
        .sub-title { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        
        /* --- Bingo Grid System (RWD) --- */
        .grid-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 0 10px; /* é€™è£¡æ‰çµ¦å·¦å³ç•™ç™½ */
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 5px; 
            width: 100%;
            max-width: 500px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…åœ¨å¤§è¢å¹•å¤ªå¯¬ */
            /* é—œéµï¼šè®“æ ¼å­ä¿æŒæ­£æ–¹å½¢ï¼Œä¸”ä¸è¶…å‡ºè¢å¹• */
            aspect-ratio: 1/1; 
        }

        .cell { 
            background: white; 
            border: 1px solid #b71c1c; 
            border-radius: 6px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            position: relative;
            overflow: hidden;
            transition: background 0.2s;
        }
        
        .cell.active { background: #b71c1c; color: white; }
        
        /* å…§å®¹å­—é«”è‡ªé©æ‡‰ */
        .icon { font-size: clamp(12px, 4vw, 20px); margin-bottom: 2px; }
        .name { 
            font-weight: bold; 
            font-size: clamp(8px, 2.5vw, 11px); 
            line-height: 1.1; 
            width: 90%;
            word-break: break-all;
        }
        
        .debug-dot { 
            position: absolute; top: 2px; left: 2px; width: 4px; height: 4px; 
            background: #ccc; border-radius: 50%; display: none; 
        }

        /* --- UI Components --- */
        .bottom-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: rgba(255, 255, 255, 0.95); padding: 10px 20px; 
            border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            display: flex; gap: 15px; align-items: center; z-index: 100;
            width: 90%; max-width: 400px; justify-content: space-between;
        }
        
        .status-text { font-size: 12px; color: #555; text-align: left; }
        
        .btn { 
            background: #b71c1c; color: white; border: none; padding: 10px 20px; 
            border-radius: 20px; font-weight: bold; font-size: 14px; flex-shrink: 0;
        }

        /* --- Loading Mask (é—œéµï¼šé˜²æ­¢ç•«é¢è·³å‹•) --- */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdf5e6; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.3s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #ddd;
            border-top: 4px solid #b71c1c; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Winner Overlay --- */
        #winner-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(183, 28, 28, 0.95); color: white;
            flex-direction: column; align-items: center; justify-content: center; z-index: 9000;
        }
    </style>
</head>
<body>

    <div id="loading-mask">
        <div class="spinner"></div>
        <div id="loading-text" style="color:#666; font-size:12px; font-weight:bold;">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
    </div>

    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" width="30" style="margin-top:10px; opacity: 0.8;">
    <h1 id="event-title">è¼‰å…¥ä¸­...</h1>
    <div class="sub-title"><span id="user-name">...</span></div>

    <div class="grid-container">
        <div class="grid" id="bingo-grid"></div>
    </div>

    <div class="bottom-bar">
        <div class="status-text" id="status-text">ğŸ“ GPS å¾…å‘½</div>
        <button class="btn" onclick="checkLocation()">æ‰“å¡</button>
    </div>

    <div id="winner-overlay">
        <h2 style="font-size:3em; margin:0;">BINGO!</h2>
        <p>æ­å–œå®Œæˆé€£ç·š</p>
        <button class="btn" style="background:white; color:#b71c1c; margin-top:20px;" onclick="closeWinner()">ç¹¼çºŒ</button>
    </div>

<script>
    // âš ï¸ è«‹å¡«å…¥æ‚¨æœ€æ–°çš„ GAS ç¶²å€
    const SYSTEM_CONFIG = {
        liffId: "2008939051-CMBzqbtq",
        googleScriptUrl: "https://script.google.com/macros/s/AKfycbxC51dEy8oKWhWnxOYS4GN6_ZYbqXNejhnS6yg1Wva2cA8CAQSta42Vz1dcTZLN0NhCHA/exec"
    };

    // 25 å€‹åœ°é» (ç²¾ç°¡ç‰ˆ)
    const locations = [
       { id: 1, name: "å¤§ç¨»åŸ•è²¨æ«ƒ", region: "å¤§ç¨»åŸ•", lat: 25.0575, lng: 121.5078, icon: "â›µ" },
       { id: 2, name: "æœˆçœ‰æ¿•åœ°", region: "å¤§æºª", lat: 24.8968, lng: 121.2961, icon: "ğŸŒ³" },
       { id: 3, name: "æµ·å€«å’–å•¡", region: "çŸ³ç¢‡", lat: 24.9634, lng: 121.6247, icon: "â˜•" },
       { id: 4, name: "é™¶ç“·åšç‰©é¤¨", region: "é¶¯æ­Œ", lat: 24.9496, lng: 121.3537, icon: "ğŸº" },
       { id: 5, name: "é¦¬å ´ç”º", region: "è¬è¯", lat: 25.0207, lng: 121.5032, icon: "ğŸŒ³" },
       { id: 6, name: "å»–æ·»ä¸å»Ÿ", region: "å…«é‡Œ", lat: 25.1472, lng: 121.3985, icon: "â›©ï¸" },
       { id: 7, name: "å±å±±åœ‹å°", region: "é«˜é›„", lat: 22.6895, lng: 120.3092, icon: "ğŸ«" },
       { id: 8, name: "é¢¨æ«ƒå˜´", region: "è¬é‡Œ", lat: 25.1352, lng: 121.6026, icon: "â›°ï¸" },
       { id: 9, name: "å¹³æºªè±†èŠ±", region: "å¹³æºª", lat: 25.0257, lng: 121.7394, icon: "ğŸ§" },
       { id: 10, name: "è§’æ¿å±±", region: "å¾©èˆˆ", lat: 24.8161, lng: 121.3513, icon: "â›°ï¸" },
       { id: 11, name: "ç¢§æ½­åŠæ©‹", region: "æ–°åº—", lat: 24.9546, lng: 121.5363, icon: "ğŸŒ‰" },
       { id: 12, name: "ç¦å±±é¦¬å®¶å ¡", region: "çƒä¾†", lat: 24.7746, lng: 121.5007, icon: "ğŸ¥¢" },
       { id: 13, name: "å£½å¡é©›ç«™", region: "å±æ±", lat: 22.2427, lng: 120.8561, icon: "ğŸ‘‘" },
       { id: 14, name: "æ±çœ¼å±±", region: "å¾©èˆˆ", lat: 24.8313, lng: 121.4079, icon: "ğŸŒ²" },
       { id: 15, name: "è²“ç©ºçºœè»Š", region: "è²“ç©º", lat: 24.9687, lng: 121.5886, icon: "ğŸš¡" },
       { id: 16, name: "é¦¬å•ä¸Šå²¸", region: "æ·¡æ°´", lat: 25.1717, lng: 121.4404, icon: "â›ª" },
       { id: 17, name: "ä¸­ç¤¾è·¯", region: "å£«æ—", lat: 25.1031, lng: 121.5583, icon: "ğŸšŒ" },
       { id: 18, name: "äºŒå­åª", region: "é™½æ˜å±±", lat: 25.1856, lng: 121.5247, icon: "ğŸ¦‹" },
       { id: 19, name: "åŠå—è·¯", region: "å…§æ¹–", lat: 25.0932, lng: 121.5552, icon: "ğŸ¦‹" },
       { id: 20, name: "è§€éŸ³å±±", region: "äº”è‚¡", lat: 25.1325, lng: 121.4243, icon: "â›°ï¸" },
       { id: 21, name: "åªæ—è€è¡—", region: "åªæ—", lat: 24.9357, lng: 121.7118, icon: "ğŸµ" },
       { id: 22, name: "æ»¿æœˆåœ“", region: "ä¸‰å³½", lat: 24.8346, lng: 121.4428, icon: "ğŸŒ²" },
       { id: 23, name: "é—œæ¸¡å®®", region: "é—œæ¸¡", lat: 25.1192, lng: 121.4673, icon: "ğŸ™" },
       { id: 24, name: "çƒä¾†ç€‘å¸ƒ", region: "çƒä¾†", lat: 24.8490, lng: 121.5513, icon: "ğŸŒŠ" },
       { id: 25, name: "å¾©èˆˆç©ºå»š", region: "æ¡ƒåœ’", lat: 25.0560, lng: 121.2480, icon: "ğŸ" }
    ];

    // æœ¬åœ°æš«å­˜ (åªä½œç‚º UI å¿«é€Ÿåæ‡‰ï¼Œæœ€çµ‚ä»¥é›²ç«¯ç‚ºä¸»)
    let myVisitedIds = [];
    let clickCounts = {};

    async function main() {
        document.getElementById('event-title').innerText = "2026 è³“æœé€£ç·š";
        try {
            await liff.init({ liffId: SYSTEM_CONFIG.liffId });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = `Hi, ${profile.displayName}`;
                
                // ğŸš€ é—œéµæ­¥é©Ÿï¼šç™»å…¥å¾Œï¼Œå…ˆå»é›²ç«¯æ‹‰è³‡æ–™ï¼Œæ‹‰å®Œæ‰ç•«æ ¼å­
                await fetchCloudData(profile.userId);
            } else {
                liff.login();
            }
        } catch (err) {
            alert("åˆå§‹åŒ–å¤±æ•—: " + err);
            document.getElementById('loading-mask').style.display = 'none'; // å¤±æ•—ä¹Ÿè¦é¡¯ç¤ºç•«é¢è®“ä½¿ç”¨è€…çœ‹åˆ°
        }
    }

    // å¾é›²ç«¯æ‹‰å–è³‡æ–™ (æ ¸å¿ƒåŒæ­¥é‚è¼¯)
    async function fetchCloudData(userId) {
        const loadingText = document.getElementById('loading-text');
        try {
            let res = await fetch(`${SYSTEM_CONFIG.googleScriptUrl}?userId=${userId}`);
            let data = await res.json();
            
            if (data.visitedIds) {
                myVisitedIds = data.visitedIds; // è¦†è“‹æœ¬åœ°è³‡æ–™ï¼Œç¢ºä¿ä¸€è‡´
                console.log("Cloud Data Loaded:", myVisitedIds);
            }
            
            renderGrid(); // è³‡æ–™æº–å‚™å¥½äº†ï¼Œç•«åœ–ï¼
            checkBingo(); // æª¢æŸ¥æœ‰æ²’æœ‰é€£ç·š
            
            // å»¶é²ä¸€é»é»é—œé–‰é®ç½©ï¼Œé«”é©—è¼ƒå¥½
            setTimeout(() => {
                document.getElementById('loading-mask').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-mask').style.display = 'none', 300);
            }, 500);

        } catch (e) {
            console.error(e);
            loadingText.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
            // å…è¨±é›¢ç·šéŠç©ï¼Œä½†ä¸ä¿è­‰åŒæ­¥
            renderGrid();
            document.getElementById('loading-mask').style.display = 'none';
        }
    }

    function renderGrid() {
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = "";
        
        locations.forEach(loc => {
            let cell = document.createElement('div');
            const isActive = myVisitedIds.includes(loc.id);
            cell.className = `cell ${isActive ? 'active' : ''}`;
            
            cell.innerHTML = `
                <div class="debug-dot" id="debug-${loc.id}"></div>
                <div class="icon">${loc.icon}</div>
                <div class="name">${loc.name}</div>
            `;

            // Debug é»æ“Šäº‹ä»¶ (é€£é» 5 ä¸‹)
            cell.onclick = () => {
                clickCounts[loc.id] = (clickCounts[loc.id] || 0) + 1;
                document.getElementById(`debug-${loc.id}`).style.display = 'block';
                
                if (clickCounts[loc.id] >= 5) {
                    // æœ¬åœ°å…ˆäº®ç‡ˆ (æ¨‚è§€æ›´æ–° UI)
                    if(!myVisitedIds.includes(loc.id)) {
                        myVisitedIds.push(loc.id);
                        renderGrid();
                        syncToCloud(); // èƒŒæ™¯åŒæ­¥
                    }
                    clickCounts[loc.id] = 0;
                }
                setTimeout(() => document.getElementById(`debug-${loc.id}`).style.display = 'none', 800);
            };

            grid.appendChild(cell);
        });
    }

    // æ‰“å¡é‚è¼¯
    function checkLocation() {
        const statusDiv = document.getElementById('status-text');
        statusDiv.innerText = "ğŸ›°ï¸ å®šä½ä¸­...";
        
        if (!navigator.geolocation) { alert("ä¸æ”¯æ´ GPS"); return; }
        
        navigator.geolocation.getCurrentPosition(pos => {
            const uLat = pos.coords.latitude;
            const uLng = pos.coords.longitude;
            let hit = false;
            
            statusDiv.innerHTML = `ğŸ“ ç¶“ç·¯åº¦å–å¾—æˆåŠŸ`;

            locations.forEach(loc => {
                // å¯¬é¬†åˆ¤å®šï¼šåŠå¾‘ 0.8km å…§å°±ç®— (å¯ä¾éœ€æ±‚èª¿æ•´)
                if (getDist(uLat, uLng, loc.lat, loc.lng) < 0.8) {
                    if (!myVisitedIds.includes(loc.id)) {
                        myVisitedIds.push(loc.id);
                        hit = true;
                        alert(`ğŸ‰ æ‰“å¡æˆåŠŸï¼š${loc.name}`);
                    } else {
                        alert(`æ‚¨å·²ç¶“å»é ${loc.name} å›‰ï¼`);
                    }
                }
            });

            if (hit) {
                renderGrid();
                checkBingo();
                syncToCloud(); // è§¸ç™¼é›²ç«¯åŒæ­¥
            } else {
                alert("âŒ é™„è¿‘æ²’æœ‰è³“æœé»");
            }

        }, err => {
            statusDiv.innerText = "âŒ å®šä½å¤±æ•—";
            alert("ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹ç¢ºèª GPS å·²é–‹å•Ÿ");
        }, { enableHighAccuracy: true });
    }

    // å¯«å…¥é›²ç«¯ (åŒ…å«åˆä½µé‚è¼¯)
    function syncToCloud() {
        const statusDiv = document.getElementById('status-text');
        statusDiv.innerText = "â˜ï¸ å­˜æª”ä¸­...";
        
        liff.getProfile().then(profile => {
            fetch(SYSTEM_CONFIG.googleScriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: profile.userId,
                    name: profile.displayName,
                    visitedIds: myVisitedIds
                })
            }).then(() => {
                statusDiv.innerText = "âœ… å·²åŒæ­¥é›²ç«¯";
                // ç‚ºäº†ä¿éšªï¼Œå¯ä»¥åœ¨é€™è£¡å† fetch ä¸€æ¬¡ï¼Œç¢ºä¿æ‹¿åˆ°çš„æ˜¯å¾Œç«¯åˆä½µå¾Œçš„æœ€æ–°çµæœ
                // ä½†ç‚ºäº† UX æµæš¢ï¼Œé€™è£¡å…ˆé¡¯ç¤ºæˆåŠŸå³å¯
            });
        });
    }

    function checkBingo() {
        const lines = [ 
            [1,2,3,4,5], [6,7,8,9,10], [11,12,13,14,15], [16,17,18,19,20], [21,22,23,24,25], 
            [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [5,10,15,20,25], 
            [1,7,13,19,25], [5,9,13,17,21] 
        ];
        let winCount = 0;
        lines.forEach(line => {
            if (line.every(id => myVisitedIds.includes(id))) winCount++;
        });
        
        if (winCount >= 5) {
            document.getElementById('winner-overlay').style.display = 'flex';
        }
    }

    function closeWinner() {
        document.getElementById('winner-overlay').style.display = 'none';
    }

    // è¨ˆç®—è·é›¢å…¬å¼
    function getDist(lat1,lon1,lat2,lon2) {
        var R = 6371; 
        var dLat = (lat2-lat1) * (Math.PI/180);
        var dLon = (lon2-lon1) * (Math.PI/180); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
    }

    // å•Ÿå‹•
    main();

</script>
</body>
</html>
