<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>æ´»å‹•è¼‰å…¥ä¸­...</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #fdf5e6; 
            text-align: center; 
            margin: 0; 
            padding: 20px 8px 140px 8px; 
            min-height: 100vh;
            overflow-x: hidden; 
            width: 100%;
        }

        h1 { color: #b71c1c; margin: 5px 0; font-size: 1.6em; font-weight: 800; }
        .sub-title { color: #666; font-size: 0.9em; margin-bottom: 12px; line-height: 1.4; }
        .user-greeting { color: #b71c1c; font-weight: bold; }
        
        /* å„€è¡¨æ¿ */
        .stats-board { display: flex; justify-content: center; margin-bottom: 12px; }
        .stat-item { background: white; border: 1px solid #ddd; padding: 6px 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-value { font-size: 18px; font-weight: 800; color: #b71c1c; }
        .stat-label { font-size: 10px; color: #888; }
        .version-tag { position: fixed; bottom: 5px; right: 5px; font-size: 9px; color: #ccc; opacity: 0.5; }

        /* æ ¼å­èˆ‡ RWD */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 3px; 
            max-width: 100%; 
            margin: 0 auto; 
            width: 100%; 
        }
        
        .cell { 
            aspect-ratio: 1/1; 
            background: white; 
            border: 1px solid #b71c1c; 
            border-radius: 6px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 1px; 
            cursor: pointer; 
            position: relative; 
            overflow: hidden; 
        }
        .cell.active { background: #b71c1c; color: white; }
        
        .icon { font-size: 16px; margin-bottom: 2px; line-height: 1; }
        .region { font-size: 9px; color: #888; margin-bottom: 1px; line-height: 1; }
        .cell.active .region { color: #ffcccc; }
        .name { 
            font-weight: bold; 
            font-size: 9px; 
            width: 100%; 
            word-break: break-all; 
            line-height: 1.1; 
            padding: 0 1px;
        }
        
        @media (max-width: 360px) {
            .grid { gap: 2px; }
            .icon { font-size: 14px; }
            .name { font-size: 8px; transform: scale(0.95); }
            .region { font-size: 8px; display: none; }
            body { padding: 15px 4px 140px 4px; }
        }

        .count-badge { position: absolute; bottom: 1px; right: 1px; background: #fff; color: #b71c1c; font-size: 8px; font-weight: 800; padding: 0px 3px; border-radius: 3px; display: none; z-index: 2; }
        .cell.active .count-badge { display: block; }
        .debug-click-indicator { position: absolute; top: 2px; left: 2px; width: 4px; height: 4px; border-radius: 50%; background: #ccc; display: none; }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        .bottom-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.98); padding: 8px 15px; border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; gap: 12px; align-items: center; white-space: nowrap; z-index: 100; width: auto; max-width: 90%; }
        .status-text { font-size: 11px; color: #555; text-align: left; min-width: 100px; line-height: 1.3; }
        .btn { background: linear-gradient(135deg, #d32f2f, #b71c1c); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 14px; flex-shrink: 0; }
        
        .rank-btn { position: absolute; top: 15px; right: 10px; background: #fbc02d; color: #333; border: none; padding: 6px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; z-index: 10; }
        
        #rank-overlay, #winner-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; justify-content: center; align-items: center; }
        #rank-overlay { background: rgba(0,0,0,0.85); }
        #winner-overlay { background: rgba(183, 28, 28, 0.98); color: white; flex-direction: column; }
        
        .rank-box { background: white; width: 85%; max-width: 400px; max-height: 70vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .rank-header { background: #b71c1c; color: white; padding: 12px; font-size: 16px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .rank-list { padding: 10px; overflow-y: auto; text-align: left; -webkit-overflow-scrolling: touch; }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid #eee; font-size: 13px; }
        .rank-line-count { color: #d32f2f; font-weight: bold; }
        
        .system-footer { margin-top: 30px; margin-bottom: 20px; font-size: 9px; color: rgba(0, 0, 0, 0.2); }

        /* Loading Mask çµæ§‹ä¿ç•™ä½†é è¨­éš±è— */
        #loading-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fdf5e6; z-index: 99999; flex-direction: column; justify-content: center; align-items: center; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #b71c1c; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <div id="loading-mask">
        <div class="loader"></div>
        <div style="color:#666; font-size:12px; font-weight:bold;">åŒæ­¥ä¸­...</div>
    </div>

    <button class="rank-btn" onclick="openRank()">ğŸ† æˆ°ç¸¾</button>
    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" width="20" style="margin-bottom:5px; opacity: 0.8;">
    <h1 id="event-title">æ´»å‹•è¼‰å…¥ä¸­</h1>
    <div class="sub-title"><span id="event-subtitle">...</span><br><span id="user-name" class="user-greeting">...</span></div>

    <div class="stats-board">
        <div class="stat-item">
            <div class="stat-label">å®Œæˆæ ¼æ•¸</div>
            <div class="stat-value"><span id="total-points">0</span> / 25</div>
        </div>
    </div>

    <div style="width: 100%; max-width: 500px; margin: 0 auto;">
        <div class="grid" id="bingo-grid"></div>
    </div>

    <div class="system-footer">Powered by <strong id="system-author">...</strong><br>&copy; 2026 <span id="system-name">...</span></div>
    
    <div class="bottom-bar">
        <div class="status-text" id="status-text">ğŸ“ GPS å¾…å‘½<br><span style="font-size:9px; color:#999;">ç²¾æº–åº¦: ä¾åœ°é»</span></div>
        <button class="btn" onclick="checkLocation()">ğŸ“ æ‰“å¡</button>
    </div>
    <div class="version-tag">v8.1 Simple</div>
    
    <div id="rank-overlay"><div class="rank-box"><div class="rank-header"><span>ğŸ† æˆ°ç¸¾æ¦œ</span><span style="cursor:pointer; padding:5px;" onclick="document.getElementById('rank-overlay').style.display='none'">âœ•</span></div><div class="rank-list" id="rank-content"><p style="text-align:center;color:#999;margin-top:20px;">è¼‰å…¥ä¸­...</p></div></div></div>
    <div id="winner-overlay"><h2>BINGO!</h2><p>æ­å–œå®ŒæˆæŒ‘æˆ°</p><br><button class="btn" style="background:white;color:#b71c1c;" onclick="document.getElementById('winner-overlay').style.display='none'">æª¢è¦–æˆ°ç¸¾</button></div>

<script>
    const SYSTEM_CONFIG = {
        authorName: "JUILING CHANG / CareLens",   
        systemName: "GoBingo",    
        eventTitle: "æ”¿å¤§EMBAè‡ªè¡Œè»Šç¤¾",
        eventSubtitle: "2026 è³“æœé€£ç·šæŒ‘æˆ°",
        liffId: "2008939051-CMBzqbtq",
        googleScriptUrl: "https://script.google.com/macros/s/AKfycbxC51dEy8oKWhWnxOYS4GN6_ZYbqXNejhnS6yg1Wva2cA8CAQSta42Vz1dcTZLN0NhCHA/exec"
    };

    const locations = [
        { id: 1, region: "å¤§ç¨»åŸ•", name: "è²¨æ«ƒå¸‚é›†", lat: 25.0575, lng: 121.5078, icon: "â›µ", radius: 0.8 },
        { id: 2, region: "å¤§æºª", name: "æœˆçœ‰æ¿•åœ°", lat: 24.8968, lng: 121.2961, icon: "ğŸŒ³", radius: 0.8 },
        { id: 3, region: "çŸ³ç¢‡", name: "æµ·å€«å’–å•¡", lat: 24.9634, lng: 121.6247, icon: "â˜•", radius: 0.3 },
        { id: 4, region: "é¶¯æ­Œ", name: "é™¶ç“·åšç‰©é¤¨", lat: 24.9496, lng: 121.3537, icon: "ğŸº", radius: 0.5 },
        { id: 5, region: "è¬è¯", name: "é¦¬å ´ç”º", lat: 25.0207, lng: 121.5032, icon: "ğŸŒ³", radius: 1.0 },
        { id: 6, region: "å…«é‡Œ", name: "å»–æ·»ä¸å»Ÿ", lat: 25.1472, lng: 121.3985, icon: "â›©ï¸" },
        { id: 7, region: "é«˜é›„", name: "å±å±±åœ‹å°", lat: 22.6895, lng: 120.3092, icon: "ğŸ«" },
        { id: 8, region: "è¬é‡Œ", name: "é¢¨æ«ƒå˜´", lat: 25.1352, lng: 121.6026, icon: "â›°ï¸", radius: 0.3 },
        { id: 9, region: "å¹³æºª", name: "å¹³æºªè±†èŠ±", lat: 25.0257, lng: 121.7394, icon: "ğŸ§", radius: 0.3 },
        { id: 10, region: "å¾©èˆˆ", name: "è§’æ¿å±±", lat: 24.8161, lng: 121.3513, icon: "â›°ï¸", radius: 1.0 },
        { id: 11, region: "æ–°åº—", name: "ç¢§æ½­åŠæ©‹", lat: 24.9546, lng: 121.5363, icon: "ğŸŒ‰" },
        { id: 12, region: "çƒä¾†", name: "é¦¬å®¶å ¡", lat: 24.7746, lng: 121.5007, icon: "ğŸ¥¢", radius: 0.5 },
        { id: 13, region: "å±æ±", name: "å£½å¡", lat: 22.2427, lng: 120.8561, icon: "ğŸ‘‘" }, 
        { id: 14, region: "å¾©èˆˆ", name: "æ±çœ¼å±±", lat: 24.8313, lng: 121.4079, icon: "ğŸŒ²", radius: 1.0 },
        { id: 15, region: "è²“ç©º", name: "çºœè»Šçµ‚é»", lat: 24.9687, lng: 121.5886, icon: "ğŸš¡" },
        { id: 16, region: "æ·¡æ°´", name: "é¦¬å•ä¸Šå²¸", lat: 25.1717, lng: 121.4404, icon: "â›ª", radius: 0.5 },
        { id: 17, region: "å£«æ—", name: "ä¸­ç¤¾è·¯é ‚", lat: 25.1031, lng: 121.5583, icon: "ğŸšŒ" },
        { id: 18, region: "é™½æ˜å±±", name: "äºŒå­åª", lat: 25.1856, lng: 121.5247, icon: "ğŸ¦‹", radius: 0.8 },
        { id: 19, region: "å…§æ¹–", name: "åŠå—è·¯é ‚", lat: 25.0932, lng: 121.5552, icon: "ğŸ¦‹" },
        { id: 20, region: "äº”è‚¡", name: "è§€éŸ³å±±", lat: 25.1325, lng: 121.4243, icon: "â›°ï¸", radius: 0.5 },
        { id: 21, region: "åªæ—", name: "åªæ—è€è¡—", lat: 24.9357, lng: 121.7118, icon: "ğŸµ", radius: 0.5 },
        { id: 22, region: "ä¸‰å³½", name: "æ»¿æœˆåœ“", lat: 24.8346, lng: 121.4428, icon: "ğŸŒ²", radius: 0.8 },
        { id: 23, region: "é—œæ¸¡", name: "é—œæ¸¡å®®", lat: 25.1192, lng: 121.4673, icon: "ğŸ™" },
        { id: 24, region: "çƒä¾†", name: "çƒä¾†ç€‘å¸ƒ", lat: 24.8490, lng: 121.5513, icon: "ğŸŒŠ", radius: 0.5 },
        { id: 25, region: "æ¡ƒåœ’", name: "å¾©èˆˆç©ºå»š", lat: 25.0560, lng: 121.2480, icon: "ğŸ", radius: 0.5 }
    ];

    let visitLogs = JSON.parse(localStorage.getItem('bingoLogs_nccu_2026')) || {};
    let clickCounts = {};
    let isDataLoaded = false;
    let syncTimer = null;
    let currentUserId = null;

    function applyConfig() {
        document.title = SYSTEM_CONFIG.eventTitle;
        document.getElementById('event-title').innerText = SYSTEM_CONFIG.eventTitle;
        document.getElementById('event-subtitle').innerText = SYSTEM_CONFIG.eventSubtitle;
        document.getElementById('system-author').innerText = SYSTEM_CONFIG.authorName;
        document.getElementById('system-name').innerText = SYSTEM_CONFIG.systemName;
    }

    function calculateStats() {
        let points = 0;
        locations.forEach(loc => {
            const logs = visitLogs[loc.id] || [];
            if(logs.length > 0) points++;
        });
        document.getElementById('total-points').innerText = points + " / 25";
    }

    function init() {
        applyConfig();
        calculateStats();
        
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = "";
        locations.forEach(loc => {
            let cell = document.createElement('div');
            const logs = visitLogs[loc.id] || [];
            const count = logs.length;
            const isActive = count > 0;
            
            cell.className = 'cell ' + (isActive ? 'active' : '');
            const badgeHtml = count > 0 ? `<div class="count-badge">x${count}</div>` : '';
            const debugHtml = `<div class="debug-click-indicator" id="debug-${loc.id}"></div>`;

            cell.innerHTML = `
                ${debugHtml}
                <div class="region">${loc.region}</div>
                <div class="icon">${loc.icon}</div>
                <div class="name">${loc.name}</div>
                ${badgeHtml}
            `;
            
            cell.onclick = () => {
                clickCounts[loc.id] = (clickCounts[loc.id] || 0) + 1;
                document.getElementById(`debug-${loc.id}`).style.display = 'block';
                if(clickCounts[loc.id] >= 5) {
                    if(count > 0) {
                         if(confirm(`ğŸ“ ${loc.name}\næ¬¡æ•¸ï¼š${count}\n\nç¢ºå®š = æ­¸é›¶\nå–æ¶ˆ = å¢åŠ  (+1)`)) {
                             delete visitLogs[loc.id]; 
                             saveAndReload(true); 
                         } else { markVisited(loc.id, true); }
                    } else { markVisited(loc.id, true); }
                    clickCounts[loc.id] = 0; 
                }
                setTimeout(()=> document.getElementById(`debug-${loc.id}`).style.display = 'none', 1000);
            };
            grid.appendChild(cell);
        });
        checkBingo();
    }

    // ğŸ”¥ èƒŒæ™¯åŒæ­¥è³‡æ–™ (ç§»é™¤èº«åˆ†åˆ¤æ–·é‚è¼¯)
    function loadUserDataFromCloud(userId) {
        const statusDiv = document.getElementById('status-text');
        
        fetch(SYSTEM_CONFIG.googleScriptUrl + "?userId=" + userId)
        .then(response => response.json())
        .then(data => {
            // åªåŒæ­¥æ‰“å¡ç´€éŒ„
            if (data.visitLogs) {
                let cloudLogs = data.visitLogs;
                let hasChange = false;
                for(let locId in cloudLogs) {
                    let localArr = visitLogs[locId] || [];
                    let cloudArr = cloudLogs[locId] || [];
                    let merged = [...new Set([...localArr, ...cloudArr])].sort();
                    if(merged.length > localArr.length) {
                        visitLogs[locId] = merged;
                        hasChange = true;
                    }
                }
                if (hasChange) {
                    localStorage.setItem('bingoLogs_nccu_2026', JSON.stringify(visitLogs));
                    init(); 
                    statusDiv.innerHTML = "âœ… è³‡æ–™å·²åŒæ­¥";
                    setTimeout(() => { if(!statusDiv.innerHTML.includes('ç¶“:')) statusDiv.innerHTML = "ğŸ“ GPS å¾…å‘½"; }, 2000);
                }
            }
            isDataLoaded = true;
        })
        .catch(err => {
            console.error("Bg sync failed", err);
            isDataLoaded = true;
        });
    }

    function markVisited(id, isManual) {
        if(!visitLogs[id]) visitLogs[id] = [];
        visitLogs[id].push(Date.now());
        saveAndReload(false, isManual ? null : id);
    }
    
    function saveAndReload(isRemove, alertId) {
        localStorage.setItem('bingoLogs_nccu_2026', JSON.stringify(visitLogs));
        init();
        if(alertId) {
            const locObj = locations.find(x=>x.id===alertId);
            const count = visitLogs[alertId].length;
            alert(`ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${locObj.name}\n(ç´¯ç©æ¬¡æ•¸: ${count})`);
        }
        triggerSmartSync();
    }

    function triggerSmartSync() {
        const statusDiv = document.getElementById('status-text');
        if (syncTimer) clearTimeout(syncTimer);
        statusDiv.innerHTML = "â³ æº–å‚™åŒæ­¥...";
        syncTimer = setTimeout(() => { syncToGoogleSheet(); }, 2000);
    }

    function syncToGoogleSheet() {
        const statusDiv = document.getElementById('status-text');
        if (!isDataLoaded) return;
        if (!liff.isLoggedIn()) { statusDiv.innerHTML = "âš ï¸ æœªç™»å…¥"; return; }
        
        statusDiv.innerHTML = "â˜ï¸ åŒæ­¥ä¸­...";
        liff.getProfile().then(profile => {
            const payload = {
                userId: profile.userId,
                name: profile.displayName,
                visitLogs: visitLogs 
            };
            fetch(SYSTEM_CONFIG.googleScriptUrl, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                statusDiv.innerHTML = "âœ… è³‡æ–™å·²å­˜æª”";
                setTimeout(() => { if(!statusDiv.innerHTML.includes('ç¶“:')) statusDiv.innerHTML = "ğŸ“ GPS å¾…å‘½"; }, 2000);
            });
        });
    }

    function checkLocation() {
        const statusText = document.getElementById('status-text');
        statusText.innerHTML = "ğŸ›°ï¸ å®šä½ä¸­...";
        if (!navigator.geolocation) { alert("éŒ¯èª¤ï¼šä¸æ”¯æ´ GPS"); return; }
        navigator.geolocation.getCurrentPosition(position => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            let foundCount = 0;
            statusText.innerHTML = `ğŸ“ ç¶“:${userLng.toFixed(3)} ç·¯:${userLat.toFixed(3)}<br><span style='font-size:9px'>èª¤å·®: ä¾åœ°é»</span>`;
            locations.forEach(loc => {
                const targetRadius = loc.radius || 0.5; 
                const dist = getDistanceFromLatLonInKm(userLat, userLng, loc.lat, loc.lng);
                if (dist < targetRadius) { markVisited(loc.id, false); foundCount++; }
            });
            if(foundCount === 0) alert("âŒ é™„è¿‘æ²’æœ‰è³“æœé»");
        }, error => {
            statusText.innerHTML = "âŒ å®šä½å¤±æ•—";
            alert("è«‹é–‹å•Ÿ GPS");
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }

    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function checkBingo() {
        let activeIds = [];
        for(let id in visitLogs) {
            if(visitLogs[id].length > 0) activeIds.push(Number(id));
        }
        const lines = [ [1,2,3,4,5], [6,7,8,9,10], [11,12,13,14,15], [16,17,18,19,20], [21,22,23,24,25], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [5,10,15,20,25], [1,7,13,19,25], [5,9,13,17,21] ];
        let winCount = 0;
        lines.forEach(line => { if (line.every(id => activeIds.includes(id))) winCount++; });
        if (winCount >= 5) document.getElementById('winner-overlay').style.display = 'flex';
        else document.getElementById('winner-overlay').style.display = 'none';
        return winCount;
    }

    function openRank() {
        document.getElementById('rank-overlay').style.display = 'flex';
        const listDiv = document.getElementById('rank-content');
        listDiv.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px;">è¼‰å…¥ä¸­...</p>';
        fetch(SYSTEM_CONFIG.googleScriptUrl)
        .then(response => response.json())
        .then(data => {
            let html = "";
            if(data.length === 0) {
                html = '<p style="text-align:center;margin-top:20px;">ç„¡è³‡æ–™</p>';
            } else {
                data.forEach((user, index) => {
                    let visitedNames = [];
                    if(user.visited) {
                        const ids = user.visited.toString().split(',');
                        visitedNames = ids.slice(0, 3).map(id => {
                            const loc = locations.find(l => l.id == id);
                            return loc ? loc.name : id;
                        });
                        if(ids.length > 3) visitedNames.push(`...ç­‰${ids.length}è™•`);
                    }
                    const visitedStr = visitedNames.length > 0 ? visitedNames.join('ã€') : 'å°šæœªå‡ºç™¼';
                    html += `<div class="rank-item"><div><strong>${index+1}. ${user.name}</strong><br><span style="font-size:10px; color:#888;">${visitedStr}</span></div><div style="text-align:right;"><div class="rank-line-count">${user.lines} é€£ç·š</div><span class="rank-badge">${user.points} æ ¼</span></div></div>`;
                });
            }
            listDiv.innerHTML = html;
        });
    }

    function registerAutoSync() {
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && currentUserId) {
                loadUserDataFromCloud(currentUserId);
            }
        });
        window.addEventListener('pageshow', (event) => {
            if (event.persisted && currentUserId) {
                loadUserDataFromCloud(currentUserId);
            }
        });
    }

    async function main() {
        // ğŸ”¥ 1. ç§’é–‹ï¼šç›´æ¥æ¸²æŸ“æœ¬åœ°è³‡æ–™ï¼Œä¸é¡¯ç¤ºé®ç½©
        init(); 
        
        try {
            await liff.init({ liffId: SYSTEM_CONFIG.liffId });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = `Hi, ${profile.displayName}`;
                currentUserId = profile.userId;
                
                // ğŸ”¥ 2. èƒŒæ™¯åŒæ­¥ï¼šä½¿ç”¨è€…ç„¡æ„Ÿï¼Œè³‡æ–™å·å·æ›´æ–°
                registerAutoSync();
                loadUserDataFromCloud(profile.userId);
            } else {
                document.getElementById('user-name').innerText = " (è¨ªå®¢æ¨¡å¼)";
                liff.login();
            }
        } catch (err) {
            document.getElementById('user-name').innerText = " (ç³»çµ±éŒ¯èª¤)";
            console.error(err);
        }
    }
    main();
</script>
</body>
</html>
