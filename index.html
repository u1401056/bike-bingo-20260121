<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>Bingo ËºâÂÖ•‰∏≠...</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- Reset & Layout --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; 
            background: #fdf5e6; 
            text-align: center; 
            margin: 0; padding: 20px 0 100px 0; 
            min-height: 100vh; overflow-x: hidden; 
        }
        
        h1 { color: #b71c1c; margin: 10px 0 5px 0; font-size: 1.6em; font-weight: 800; }
        .sub-title { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        
        /* --- Grid --- */
        .grid-container { width: 100%; display: flex; justify-content: center; padding: 0 10px; }
        .grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; 
            width: 100%; max-width: 500px; aspect-ratio: 1/1; 
        }
        .cell { 
            background: white; border: 1px solid #b71c1c; border-radius: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; overflow: hidden; 
        }
        .cell.active { background: #b71c1c; color: white; }
        .icon { font-size: clamp(12px, 4vw, 20px); margin-bottom: 2px; }
        .name { font-weight: bold; font-size: clamp(8px, 2.5vw, 11px); line-height: 1.1; width: 90%; word-break: break-all; }
        .debug-dot { position: absolute; top: 2px; left: 2px; width: 4px; height: 4px; background: #ccc; border-radius: 50%; display: none; }

        /* --- UI Components --- */
        .bottom-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: rgba(255, 255, 255, 0.95); padding: 10px 20px; 
            border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            display: flex; gap: 15px; align-items: center; z-index: 100;
            width: 90%; max-width: 400px; justify-content: space-between;
        }
        .status-text { font-size: 12px; color: #555; text-align: left; }
        .btn { background: #b71c1c; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 14px; flex-shrink: 0; }
        
        .rank-btn {
            position: absolute; top: 15px; right: 15px;
            background: #fbc02d; color: #333; border: none; padding: 6px 12px;
            border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .version-tag {
            position: fixed; bottom: 5px; right: 5px;
            font-size: 10px; color: #aaa; opacity: 0.6; z-index: 50;
        }

        /* --- Overlays --- */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdf5e6; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.3s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #ddd;
            border-top: 4px solid #b71c1c; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #rank-overlay, #winner-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9000;
            justify-content: center; align-items: center;
        }
        .rank-box {
            background: white; width: 85%; max-width: 400px; max-height: 80%;
            border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;
        }
        .rank-header {
            background: #b71c1c; color: white; padding: 15px;
            font-size: 18px; font-weight: bold; display: flex; justify-content: space-between;
        }
        .rank-list { padding: 10px; overflow-y: auto; text-align: left; }
        .rank-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 5px; border-bottom: 1px solid #eee; font-size: 14px;
        }
        .rank-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #666; margin-left: 5px; }

    </style>
</head>
<body>

    <div id="loading-mask">
        <div class="spinner"></div>
        <div id="loading-text" style="color:#666; font-size:12px; font-weight:bold;">Ê≠£Âú®ÂêåÊ≠•Èõ≤Á´ØË≥áÊñô...</div>
        <div id="loading-sub" style="color:#999; font-size:10px; margin-top:5px;">ÂàùÂßãÂåñ‰∏≠...</div>
    </div>

    <button class="rank-btn" onclick="openRank()">üèÜ Êà∞Á∏æÊ¶ú</button>

    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" width="30" style="margin-top:10px; opacity: 0.8;">
    <h1 id="event-title">ËºâÂÖ•‰∏≠...</h1>
    <div class="sub-title"><span id="user-name">...</span></div>

    <div class="grid-container">
        <div class="grid" id="bingo-grid"></div>
    </div>

    <div class="bottom-bar">
        <div class="status-text" id="status-text">üìç GPS ÂæÖÂëΩ</div>
        <button class="btn" onclick="checkLocation()">ÊâìÂç°</button>
    </div>
    
    <div class="version-tag">v2026.01.27 DebugMode</div>

    <div id="rank-overlay">
        <div class="rank-box">
            <div class="rank-header">
                <span>üèÜ ÂØ¶ÊôÇÊà∞Á∏æÊ¶ú</span>
                <span style="cursor:pointer;" onclick="document.getElementById('rank-overlay').style.display='none'">‚úï</span>
            </div>
            <div class="rank-list" id="rank-content">
                <p style="text-align:center; color:#999; margin-top:20px;">ËºâÂÖ•‰∏≠...</p>
            </div>
        </div>
    </div>

    <div id="winner-overlay">
        <div style="text-align:center; color:white;">
            <h2 style="font-size:3em; margin:0;">BINGO!</h2>
            <p>ÊÅ≠ÂñúÂÆåÊàêÈÄ£Á∑ö</p>
            <button class="btn" style="background:white; color:#b71c1c; margin-top:20px;" onclick="document.getElementById('winner-overlay').style.display='none'">ÁπºÁ∫å</button>
        </div>
    </div>

<script>
    // ‚ö†Ô∏è ÂÜçÊ¨°Á¢∫Ë™çÊÇ®ÁöÑÁ∂≤ÂùÄÊòØÂê¶Ê≠£Á¢∫ (ÁµêÂ∞æÊòØ /exec)
    const SYSTEM_CONFIG = {
        liffId: "2008939051-CMBzqbtq",
        googleScriptUrl: "https://script.google.com/macros/s/AKfycbxC51dEy8oKWhWnxOYS4GN6_ZYbqXNejhnS6yg1Wva2cA8CAQSta42Vz1dcTZLN0NhCHA/exec"
    };

    const locations = [
       { id: 1, name: "Â§ßÁ®ªÂüïË≤®Ê´É", region: "Â§ßÁ®ªÂüï", lat: 25.0575, lng: 121.5078, icon: "‚õµ" },
       { id: 2, name: "ÊúàÁúâÊøïÂú∞", region: "Â§ßÊ∫™", lat: 24.8968, lng: 121.2961, icon: "üå≥" },
       { id: 3, name: "Êµ∑ÂÄ´ÂíñÂï°", region: "Áü≥Á¢á", lat: 24.9634, lng: 121.6247, icon: "‚òï" },
       { id: 4, name: "Èô∂Áì∑ÂçöÁâ©È§®", region: "È∂ØÊ≠å", lat: 24.9496, lng: 121.3537, icon: "üè∫" },
       { id: 5, name: "È¶¨Â†¥Áî∫", region: "Ëê¨ËèØ", lat: 25.0207, lng: 121.5032, icon: "üå≥" },
       { id: 6, name: "ÂªñÊ∑ª‰∏ÅÂªü", region: "ÂÖ´Èáå", lat: 25.1472, lng: 121.3985, icon: "‚õ©Ô∏è" },
       { id: 7, name: "Â±èÂ±±ÂúãÂ∞è", region: "È´òÈõÑ", lat: 22.6895, lng: 120.3092, icon: "üè´" },
       { id: 8, name: "È¢®Ê´ÉÂò¥", region: "Ëê¨Èáå", lat: 25.1352, lng: 121.6026, icon: "‚õ∞Ô∏è" },
       { id: 9, name: "Âπ≥Ê∫™Ë±ÜËä±", region: "Âπ≥Ê∫™", lat: 25.0257, lng: 121.7394, icon: "üçß" },
       { id: 10, name: "ËßíÊùøÂ±±", region: "Âæ©Ëàà", lat: 24.8161, lng: 121.3513, icon: "‚õ∞Ô∏è" },
       { id: 11, name: "Á¢ßÊΩ≠ÂêäÊ©ã", region: "Êñ∞Â∫ó", lat: 24.9546, lng: 121.5363, icon: "üåâ" },
       { id: 12, name: "Á¶èÂ±±È¶¨ÂÆ∂Â†°", region: "ÁÉè‰æÜ", lat: 24.7746, lng: 121.5007, icon: "ü•¢" },
       { id: 13, name: "Â£ΩÂç°È©õÁ´ô", region: "Â±èÊù±", lat: 22.2427, lng: 120.8561, icon: "üëë" },
       { id: 14, name: "Êù±ÁúºÂ±±", region: "Âæ©Ëàà", lat: 24.8313, lng: 121.4079, icon: "üå≤" },
       { id: 15, name: "Ë≤ìÁ©∫Á∫úËªä", region: "Ë≤ìÁ©∫", lat: 24.9687, lng: 121.5886, icon: "üö°" },
       { id: 16, name: "È¶¨ÂÅï‰∏äÂ≤∏", region: "Ê∑°Ê∞¥", lat: 25.1717, lng: 121.4404, icon: "‚õ™" },
       { id: 17, name: "‰∏≠Á§æË∑Ø", region: "Â£´Êûó", lat: 25.1031, lng: 121.5583, icon: "üöå" },
       { id: 18, name: "‰∫åÂ≠êÂù™", region: "ÈôΩÊòéÂ±±", lat: 25.1856, lng: 121.5247, icon: "ü¶ã" },
       { id: 19, name: "ÂäçÂçóË∑Ø", region: "ÂÖßÊπñ", lat: 25.0932, lng: 121.5552, icon: "ü¶ã" },
       { id: 20, name: "ËßÄÈü≥Â±±", region: "‰∫îËÇ°", lat: 25.1325, lng: 121.4243, icon: "‚õ∞Ô∏è" },
       { id: 21, name: "Âù™ÊûóËÄÅË°ó", region: "Âù™Êûó", lat: 24.9357, lng: 121.7118, icon: "üçµ" },
       { id: 22, name: "ÊªøÊúàÂúì", region: "‰∏âÂ≥Ω", lat: 24.8346, lng: 121.4428, icon: "üå≤" },
       { id: 23, name: "ÈóúÊ∏°ÂÆÆ", region: "ÈóúÊ∏°", lat: 25.1192, lng: 121.4673, icon: "üôè" },
       { id: 24, name: "ÁÉè‰æÜÁÄëÂ∏É", region: "ÁÉè‰æÜ", lat: 24.8490, lng: 121.5513, icon: "üåä" },
       { id: 25, name: "Âæ©ËààÁ©∫Âªö", region: "Ê°ÉÂúí", lat: 25.0560, lng: 121.2480, icon: "üçû" }
    ];

    let myVisitedIds = [];
    let clickCounts = {};

    async function main() {
        document.getElementById('event-title').innerText = "2026 Ë≥ìÊûúÈÄ£Á∑ö";
        const subLoading = document.getElementById('loading-sub');

        try {
            subLoading.innerText = "LIFF ÂàùÂßãÂåñ‰∏≠...";
            await liff.init({ liffId: SYSTEM_CONFIG.liffId });
            
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = `Hi, ${profile.displayName}`;
                
                // ÈñãÂßãÂêåÊ≠•
                subLoading.innerText = "Ê≠£Âú®ÈÄ£Á∑ö Google Ë≥áÊñôÂ∫´...";
                await fetchCloudData(profile.userId);
            } else {
                subLoading.innerText = "Ë´ãÁôªÂÖ• LINE...";
                liff.login();
            }
        } catch (err) {
            alert("‚ö†Ô∏è ÈåØË™§: " + err);
            // ÁôºÁîüÈåØË™§‰πüË¶ÅÁßªÈô§ÈÅÆÁΩ©Ôºå‰∏çÁÑ∂ÊúÉÂç°Ê≠ª
            closeLoadingMask();
        }
    }

    async function fetchCloudData(userId) {
        const timestamp = new Date().getTime();
        
        // Ë®≠ÂÆö 8 ÁßíË∂ÖÊôÇÊ©üÂà∂ÔºåÈÅøÂÖçÂç°Ê≠ª
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error("Timeout")), 8000)
        );

        try {
            // Promise.race: ÁúãÊòØË≥áÊñôÂÖàÂõû‰æÜÔºåÈÇÑÊòØÂÖàË∂ÖÊôÇ
            const response = await Promise.race([
                fetch(`${SYSTEM_CONFIG.googleScriptUrl}?userId=${userId}&t=${timestamp}`),
                timeoutPromise
            ]);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.visitedIds) {
                myVisitedIds = data.visitedIds;
            } else {
                // Â¶ÇÊûúÂõûÂÇ≥Ë≥áÊñôÊ†ºÂºè‰∏çÂ∞çÔºåÂèØËÉΩÊòØÊ¨äÈôêÂïèÈ°å
                console.warn("Ë≥áÊñôÊ†ºÂºèÁï∞Â∏∏", data);
            }

        } catch (e) {
            console.error(e);
            if (e.message === "Timeout") {
                alert("‚è≥ ÈÄ£Á∑öÈÄæÊôÇÔºÅ\nË´ãÊ™¢Êü•Á∂≤Ë∑ØÔºåÊàñÁ®çÂæåÂÜçË©¶„ÄÇ\n(ÁõÆÂâçÂ∞áÈÄ≤ÂÖ•Èõ¢Á∑öÊ®°Âºè)");
            } else {
                // ÈÄôË£°ÊúÄÂ∏∏Âá∫ÁèæÁöÑÊòØÊ¨äÈôêÈåØË™§
                alert("‚ùå ÂêåÊ≠•Â§±ÊïóÔºÅ\nË´ãÊ™¢Êü• GAS Ê¨äÈôêÊòØÂê¶Ë®≠ÁÇ∫„ÄåÊâÄÊúâ‰∫∫„Äç„ÄÇ\nÈåØË™§Ë®äÊÅØ: " + e.message);
            }
        } finally {
            // ÁÑ°Ë´ñÊàêÂäüÂ§±ÊïóÔºåÈÉΩË¶ÅÊ∏≤ÊüìÁï´Èù¢‰∏¶ÈóúÈñâÈÅÆÁΩ©
            renderGrid();
            checkBingo();
            closeLoadingMask();
        }
    }
    
    function closeLoadingMask() {
        const mask = document.getElementById('loading-mask');
        mask.style.opacity = '0';
        setTimeout(() => mask.style.display = 'none', 300);
    }

    // ËÆÄÂèñÊéíË°åÊ¶ú
    function openRank() {
        document.getElementById('rank-overlay').style.display = 'flex';
        const listDiv = document.getElementById('rank-content');
        listDiv.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">ËºâÂÖ•‰∏≠...</p>';
        
        const timestamp = new Date().getTime();
        fetch(`${SYSTEM_CONFIG.googleScriptUrl}?t=${timestamp}`)
        .then(res => res.json())
        .then(data => {
            let html = "";
            if(!Array.isArray(data) || data.length === 0) {
                html = '<p style="text-align:center; margin-top:20px;">Â∞öÁÑ°Ë≥áÊñô</p>';
            } else {
                data.forEach((user, index) => {
                    html += `
                        <div class="rank-item">
                            <div>
                                <strong>${index+1}. ${user.name}</strong>
                            </div>
                            <div style="text-align:right;">
                                <span style="color:#d32f2f; font-weight:bold;">${user.lines} ÈÄ£Á∑ö</span>
                                <span class="rank-badge">${user.points} Ê†º</span>
                            </div>
                        </div>`;
                });
            }
            listDiv.innerHTML = html;
        })
        .catch(err => {
            listDiv.innerHTML = '<p style="text-align:center; color:red; margin-top:20px;">ËÆÄÂèñÂ§±Êïó (Ë´ãÊ™¢Êü•Ê¨äÈôê)</p>';
        });
    }

    function renderGrid() {
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = "";
        
        locations.forEach(loc => {
            let cell = document.createElement('div');
            const isActive = myVisitedIds.includes(loc.id);
            cell.className = `cell ${isActive ? 'active' : ''}`;
            
            cell.innerHTML = `
                <div class="debug-dot" id="debug-${loc.id}"></div>
                <div class="icon">${loc.icon}</div>
                <div class="name">${loc.name}</div>
            `;

            cell.onclick = () => {
                clickCounts[loc.id] = (clickCounts[loc.id] || 0) + 1;
                document.getElementById(`debug-${loc.id}`).style.display = 'block';
                
                if (clickCounts[loc.id] >= 5) {
                    if(!myVisitedIds.includes(loc.id)) {
                        myVisitedIds.push(loc.id);
                        renderGrid();
                        syncToCloud(); 
                    }
                    clickCounts[loc.id] = 0;
                }
                setTimeout(() => document.getElementById(`debug-${loc.id}`).style.display = 'none', 800);
            };

            grid.appendChild(cell);
        });
    }

    function checkLocation() {
        const statusDiv = document.getElementById('status-text');
        statusDiv.innerText = "üõ∞Ô∏è ÂÆö‰Ωç‰∏≠...";
        
        if (!navigator.geolocation) { alert("‰∏çÊîØÊè¥ GPS"); return; }
        
        navigator.geolocation.getCurrentPosition(pos => {
            const uLat = pos.coords.latitude;
            const uLng = pos.coords.longitude;
            let hit = false;
            
            statusDiv.innerHTML = `üìç Á∂ìÁ∑ØÂ∫¶ÂèñÂæóÊàêÂäü`;

            locations.forEach(loc => {
                if (getDist(uLat, uLng, loc.lat, loc.lng) < 0.8) {
                    if (!myVisitedIds.includes(loc.id)) {
                        myVisitedIds.push(loc.id);
                        hit = true;
                        alert(`üéâ ÊâìÂç°ÊàêÂäüÔºö${loc.name}`);
                    } else {
                        alert(`ÊÇ®Â∑≤Á∂ìÂéªÈÅé ${loc.name} ÂõâÔºÅ`);
                    }
                }
            });

            if (hit) {
                renderGrid();
                checkBingo();
                syncToCloud(); 
            } else {
                alert("‚ùå ÈôÑËøëÊ≤íÊúâË≥ìÊûúÈªû");
            }

        }, err => {
            statusDiv.innerText = "‚ùå ÂÆö‰ΩçÂ§±Êïó";
            alert("ÁÑ°Ê≥ïÂèñÂæó‰ΩçÁΩÆÔºåË´ãÁ¢∫Ë™ç GPS Â∑≤ÈñãÂïü");
        }, { enableHighAccuracy: true });
    }

    function syncToCloud() {
        const statusDiv = document.getElementById('status-text');
        statusDiv.innerText = "‚òÅÔ∏è Â≠òÊ™î‰∏≠...";
        
        liff.getProfile().then(profile => {
            fetch(SYSTEM_CONFIG.googleScriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: profile.userId,
                    name: profile.displayName,
                    visitedIds: myVisitedIds
                })
            }).then(() => {
                statusDiv.innerText = "‚úÖ Â∑≤ÂêåÊ≠•Èõ≤Á´Ø";
            }).catch(e => {
                 statusDiv.innerText = "‚ö†Ô∏è Â≠òÊ™îÂ§±Êïó";
            });
        });
    }

    function checkBingo() {
        const lines = [ 
            [1,2,3,4,5], [6,7,8,9,10], [11,12,13,14,15], [16,17,18,19,20], [21,22,23,24,25], 
            [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [5,10,15,20,25], 
            [1,7,13,19,25], [5,9,13,17,21] 
        ];
        let winCount = 0;
        lines.forEach(line => {
            if (line.every(id => myVisitedIds.includes(id))) winCount++;
        });
        if (winCount >= 5) document.getElementById('winner-overlay').style.display = 'flex';
    }

    function getDist(lat1,lon1,lat2,lon2) {
        var R = 6371; 
        var dLat = (lat2-lat1) * (Math.PI/180);
        var dLon = (lon2-lon1) * (Math.PI/180); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
    }

    main();
</script>
</body>
</html>
