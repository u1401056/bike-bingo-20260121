<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>æ´»å‹•è¼‰å…¥ä¸­...</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: -apple-system, sans-serif; background: #fdf5e6; text-align: center; margin: 0; padding: 20px 10px 150px 10px; min-height: 100vh; }
        h1 { color: #b71c1c; margin: 10px 0 5px 0; font-size: 1.8em; font-weight: 800; }
        .sub-title { color: #666; font-size: 0.95em; margin-bottom: 15px; }
        .user-greeting { color: #b71c1c; font-weight: bold; }
        
        /* --- æ•¸æ“šå„€è¡¨æ¿ --- */
        .stats-board { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .stat-item { background: white; border: 1px solid #ddd; padding: 5px 15px; border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-value { font-size: 16px; font-weight: 800; color: #b71c1c; }
        .stat-label { font-size: 10px; color: #888; }
        .version-tag { position: fixed; bottom: 5px; right: 5px; font-size: 9px; color: #ccc; opacity: 0.5; }

        /* --- Bingo æ ¼å­ --- */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; max-width: 600px; margin: 0 auto; }
        .cell { aspect-ratio: 1/1; background: white; border: 1.5px solid #b71c1c; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; cursor: pointer; position: relative; }
        .cell.active { background: #b71c1c; color: white; }
        .icon { font-size: 18px; margin-bottom: 2px; }
        .region { font-size: 10px; color: #888; margin-bottom: 2px; }
        .cell.active .region { color: #ffcccc; }
        .name { font-weight: bold; font-size: 10px; width: 100%; word-break: break-all; }
        .km-tag { font-size: 8px; color: #999; }
        .cell.active .km-tag { color: #ffcccc; }
        
        /* è¨ˆæ•¸èˆ‡é™¤éŒ¯æ¨™è¨˜ */
        .count-badge { position: absolute; bottom: 2px; right: 2px; background: #fff; color: #b71c1c; font-size: 9px; font-weight: 800; padding: 1px 4px; border-radius: 4px; display: none; }
        .cell.active .count-badge { display: block; }
        .debug-click-indicator { position: absolute; top: 2px; left: 2px; width: 4px; height: 4px; border-radius: 50%; background: #ccc; display: none; }

        /* --- åº•éƒ¨æ§åˆ¶åˆ— --- */
        .bottom-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); padding: 8px 12px; border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; gap: 10px; align-items: center; white-space: nowrap; z-index: 100; }
        .status-text { font-size: 11px; color: #555; text-align: left; min-width: 120px;}
        .btn { background: linear-gradient(135deg, #d32f2f, #b71c1c); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 15px; }
        
        /* --- å½ˆçª—èˆ‡æ’è¡Œæ¦œ --- */
        .rank-btn { position: absolute; top: 15px; right: 15px; background: #fbc02d; color: #333; border: none; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; }
        #rank-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; }
        .rank-box { background: white; width: 85%; max-width: 400px; max-height: 80%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .rank-header { background: #b71c1c; color: white; padding: 15px; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; }
        .rank-list { padding: 10px; overflow-y: auto; text-align: left; }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid #eee; font-size: 14px; }
        .rank-line-count { color: #d32f2f; font-weight: bold; }
        
        .system-footer { margin-top: 40px; margin-bottom: 20px; font-size: 9px; color: rgba(0, 0, 0, 0.2); }
        #winner-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(183, 28, 28, 0.95); color: white; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        
        /* --- ğŸ”¥ è®€å–é®ç½© (Loading Mask) --- */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdf5e6; z-index: 99999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #b71c1c;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <div id="loading-mask">
        <div class="loader"></div>
        <div style="color:#666; font-size:14px; font-weight:bold;">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
    </div>

    <button class="rank-btn" onclick="openRank()">ğŸ† æˆ°ç¸¾æ¦œ</button>
    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" width="24" style="margin-bottom:5px; opacity: 0.8;">
    <h1 id="event-title">æ´»å‹•æ¨™é¡Œè¼‰å…¥ä¸­</h1>
    <div class="sub-title"><span id="event-subtitle">...</span><br><span id="user-name" class="user-greeting">è®€å–ä¸­...</span></div>

    <div class="stats-board">
        <div class="stat-item"><div class="stat-label">ç´¯ç©ç©åˆ†é‡Œç¨‹</div><div class="stat-value"><span id="total-km">0</span> km</div></div>
        <div class="stat-item"><div class="stat-label">å®Œæˆæ ¼æ•¸</div><div class="stat-value"><span id="total-points">0</span> / 25</div></div>
    </div>

    <div class="grid" id="bingo-grid"></div>

    <div class="system-footer">Powered by <strong id="system-author">...</strong><br>System &copy; 2026 <span id="system-name">...</span>.</div>
    <div class="bottom-bar">
        <div class="status-text" id="status-text">ğŸ“ GPS å¾…å‘½<br><span style="font-size:9px; color:#999;">ç²¾æº–åº¦éœ€æ±‚: ä¾åœ°é»</span></div>
        <button class="btn" onclick="checkLocation()">ğŸ“ æ‰“å¡éµ</button>
    </div>
    <div class="version-tag">v6.1 AutoSync</div>
    
    <div id="rank-overlay"><div class="rank-box"><div class="rank-header"><span>ğŸ† å¯¦æ™‚æˆ°ç¸¾æ¦œ</span><span class="close-rank" onclick="document.getElementById('rank-overlay').style.display='none'">âœ•</span></div><div class="rank-list" id="rank-content"><p style="text-align:center;color:#999;margin-top:20px;">è¼‰å…¥ä¸­...</p></div></div></div>
    <div id="winner-overlay"><h2>BINGO!</h2><p>å¤ªå¼·äº†ï¼æ­å–œå®ŒæˆæŒ‘æˆ°</p><br><button class="btn" style="background:white;color:#b71c1c;" onclick="document.getElementById('winner-overlay').style.display='none'">æª¢è¦–æˆ°ç¸¾</button></div>

<script>
    // --- ç³»çµ±é…ç½® (è«‹ç¢ºèª LIFF ID èˆ‡ Google Script URL) ---
    const SYSTEM_CONFIG = {
        authorName: "JUILING CHANG / CareLens",   
        systemName: "GoBingo Engine",    
        eventTitle: "æ”¿å¤§EMBAè‡ªè¡Œè»Šç¤¾",
        eventSubtitle: "2026 è³“æœé€£ç·šæŒ‘æˆ°",
        liffId: "2008939051-CMBzqbtq",
        googleScriptUrl: "https://script.google.com/macros/s/AKfycbxC51dEy8oKWhWnxOYS4GN6_ZYbqXNejhnS6yg1Wva2cA8CAQSta42Vz1dcTZLN0NhCHA/exec"
    };

    // --- 25å€‹åœ°é»é…ç½® ---
    const locations = [
        { id: 1, region: "å¤§ç¨»åŸ•", name: "è²¨æ«ƒå¸‚é›†", lat: 25.0575, lng: 121.5078, icon: "â›µ", radius: 0.8, km: 25 },
        { id: 2, region: "å¤§æºª", name: "æœˆçœ‰æ¿•åœ°ç”Ÿæ…‹å…¬åœ’", lat: 24.8968, lng: 121.2961, icon: "ğŸŒ³", radius: 0.8, km: 60 },
        { id: 3, region: "çŸ³ç¢‡", name: "æµ·å€«å’–å•¡", lat: 24.9634, lng: 121.6247, icon: "â˜•", radius: 0.3, km: 30 },
        { id: 4, region: "é¶¯æ­Œ", name: "é™¶ç“·åšç‰©é¤¨", lat: 24.9496, lng: 121.3537, icon: "ğŸº", radius: 0.5, km: 50 },
        { id: 5, region: "è¬è¯", name: "é¦¬å ´ç”ºå…¬åœ’", lat: 25.0207, lng: 121.5032, icon: "ğŸŒ³", radius: 1.0, km: 20 },
        { id: 6, region: "å…«é‡Œ", name: "å»–æ·»ä¸å»Ÿ", lat: 25.1472, lng: 121.3985, icon: "â›©ï¸", km: 55 },
        { id: 7, region: "é«˜é›„", name: "å±å±±åœ‹å°", lat: 22.6895, lng: 120.3092, icon: "ğŸ«", km: 350 },
        { id: 8, region: "è¬é‡Œ", name: "é¢¨æ«ƒå˜´", lat: 25.1352, lng: 121.6026, icon: "â›°ï¸", radius: 0.3, km: 45 },
        { id: 9, region: "å¹³æºª", name: "å¹³æºªè±†èŠ±", lat: 25.0257, lng: 121.7394, icon: "ğŸ§", radius: 0.3, km: 40 },
        { id: 10, region: "å¾©èˆˆ", name: "è§’æ¿å±±", lat: 24.8161, lng: 121.3513, icon: "â›°ï¸", radius: 1.0, km: 80 },
        { id: 11, region: "æ–°åº—", name: "ç¢§æ½­åŠæ©‹", lat: 24.9546, lng: 121.5363, icon: "ğŸŒ‰", km: 15 },
        { id: 12, region: "çƒä¾†", name: "ç¦å±±é¦¬å®¶å ¡", lat: 24.7746, lng: 121.5007, icon: "ğŸ¥¢", radius: 0.5, km: 65 },
        { id: 13, region: "å±æ±", name: "å£½å¡éµé¦¬é©›ç«™", lat: 22.2427, lng: 120.8561, icon: "ğŸ‘‘", km: 400 }, 
        { id: 14, region: "å¾©èˆˆ", name: "æ±çœ¼å±±", lat: 24.8313, lng: 121.4079, icon: "ğŸŒ²", radius: 1.0, km: 90 },
        { id: 15, region: "è²“ç©º", name: "çºœè»Šçµ‚é»ç«™", lat: 24.9687, lng: 121.5886, icon: "ğŸš¡", km: 20 },
        { id: 16, region: "æ·¡æ°´", name: "é¦¬å•ä¸Šå²¸è™•", lat: 25.1717, lng: 121.4404, icon: "â›ª", radius: 0.5, km: 60 },
        { id: 17, region: "å£«æ—", name: "ä¸­ç¤¾è·¯é ‚", lat: 25.1031, lng: 121.5583, icon: "ğŸšŒ", km: 35 },
        { id: 18, region: "é™½æ˜å±±", name: "äºŒå­åª", lat: 25.1856, lng: 121.5247, icon: "ğŸ¦‹", radius: 0.8, km: 50 },
        { id: 19, region: "å…§æ¹–", name: "åŠå—è·¯é ‚", lat: 25.0932, lng: 121.5552, icon: "ğŸ¦‹", km: 30 },
        { id: 20, region: "äº”è‚¡", name: "è§€éŸ³å±±éŠå®¢ä¸­å¿ƒ", lat: 25.1325, lng: 121.4243, icon: "â›°ï¸", radius: 0.5, km: 45 },
        { id: 21, region: "åªæ—", name: "åªæ—è€è¡—", lat: 24.9357, lng: 121.7118, icon: "ğŸµ", radius: 0.5, km: 50 },
        { id: 22, region: "ä¸‰å³½", name: "æ»¿æœˆåœ“", lat: 24.8346, lng: 121.4428, icon: "ğŸŒ²", radius: 0.8, km: 70 },
        { id: 23, region: "é—œæ¸¡", name: "é—œæ¸¡å®®", lat: 25.1192, lng: 121.4673, icon: "ğŸ™", km: 30 },
        { id: 24, region: "çƒä¾†", name: "çƒä¾†ç€‘å¸ƒ", lat: 24.8490, lng: 121.5513, icon: "ğŸŒŠ", radius: 0.5, km: 45 },
        { id: 25, region: "æ¡ƒåœ’", name: "å¾©èˆˆç©ºå»š", lat: 25.0560, lng: 121.2480, icon: "ğŸ", radius: 0.5, km: 65 }
    ];

    // å…¨å±€è®Šæ•¸
    let visitLogs = JSON.parse(localStorage.getItem('bingoLogs_nccu_2026')) || {};
    let clickCounts = {};
    let isDataLoaded = false;
    let syncTimer = null;
    let currentUserId = null; // å„²å­˜ç•¶å‰ User ID ä»¥ä¾›è‡ªå‹•é‡æ•´ä½¿ç”¨

    // å¥—ç”¨æ¨™é¡Œèˆ‡ä½œè€…è¨­å®š
    function applyConfig() {
        document.title = SYSTEM_CONFIG.eventTitle;
        document.getElementById('event-title').innerText = SYSTEM_CONFIG.eventTitle;
        document.getElementById('event-subtitle').innerText = SYSTEM_CONFIG.eventSubtitle;
        document.getElementById('system-author').innerText = SYSTEM_CONFIG.authorName;
        document.getElementById('system-name').innerText = SYSTEM_CONFIG.systemName;
    }

    // è¨ˆç®—é‡Œç¨‹èˆ‡çµ±è¨ˆ
    function calculateStats() {
        let totalKm = 0;
        let points = 0;
        locations.forEach(loc => {
            const logs = visitLogs[loc.id] || [];
            if(logs.length > 0) {
                points++;
                if(loc.km) totalKm += loc.km;
            }
        });
        document.getElementById('total-km').innerText = totalKm;
        document.getElementById('total-points').innerText = points + " / 25";
    }

    // åˆå§‹åŒ–/åˆ·æ–° Grid
    function init() {
        applyConfig();
        calculateStats();
        
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = "";
        locations.forEach(loc => {
            let cell = document.createElement('div');
            const logs = visitLogs[loc.id] || [];
            const count = logs.length;
            const isActive = count > 0;
            
            cell.className = 'cell ' + (isActive ? 'active' : '');
            const badgeHtml = count > 0 ? `<div class="count-badge">x${count}</div>` : '';
            const debugHtml = `<div class="debug-click-indicator" id="debug-${loc.id}"></div>`;

            cell.innerHTML = `
                ${debugHtml}
                <div class="region">${loc.region}</div>
                <div class="icon">${loc.icon}</div>
                <div class="name">${loc.name}</div>
                <div class="km-tag">${loc.km || 0}km</div>
                ${badgeHtml}
            `;
            
            // é»æ“Šäº‹ä»¶ï¼šé™¤éŒ¯æ¨¡å¼ (é€£çºŒé»æ“Š5æ¬¡)
            cell.onclick = () => {
                clickCounts[loc.id] = (clickCounts[loc.id] || 0) + 1;
                document.getElementById(`debug-${loc.id}`).style.display = 'block';
                
                if(clickCounts[loc.id] >= 5) {
                    if(count > 0) {
                         if(confirm(`ğŸ“ ${loc.name}\nç›®å‰æ¬¡æ•¸ï¼š${count}\n\næŒ‰ã€Œç¢ºå®šã€ = æ­¸é›¶ (ç§»é™¤è³‡æ–™)\næŒ‰ã€Œå–æ¶ˆã€ = å¢åŠ æ¬¡æ•¸ (+1)`)) {
                             delete visitLogs[loc.id]; 
                             saveAndReload(true); 
                         } else { markVisited(loc.id, true); }
                    } else { markVisited(loc.id, true); }
                    clickCounts[loc.id] = 0; 
                }
                setTimeout(()=> document.getElementById(`debug-${loc.id}`).style.display = 'none', 1000);
            };
            grid.appendChild(cell);
        });
        checkBingo();
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šå¾é›²ç«¯è¼‰å…¥è³‡æ–™ ---
    function loadUserDataFromCloud(userId) {
        console.log("ğŸ”„ è‡ªå‹•åŒæ­¥ä¸­...");
        
        // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ GETï¼Œå¾Œç«¯éœ€å°æ‡‰ doGet
        fetch(SYSTEM_CONFIG.googleScriptUrl + "?userId=" + userId)
        .then(response => response.json())
        .then(data => {
            if (data.visitLogs) {
                let cloudLogs = data.visitLogs;
                let hasChange = false;
                // åˆä½µé‚è¼¯ï¼šæœ¬åœ° + é›²ç«¯ å–è¯é›†
                for(let locId in cloudLogs) {
                    let localArr = visitLogs[locId] || [];
                    let cloudArr = cloudLogs[locId] || [];
                    let merged = [...new Set([...localArr, ...cloudArr])].sort();
                    
                    if(merged.length > localArr.length) {
                        visitLogs[locId] = merged;
                        hasChange = true;
                    }
                }
                if (hasChange) {
                    localStorage.setItem('bingoLogs_nccu_2026', JSON.stringify(visitLogs));
                    init(); 
                    console.log("âœ… åŒæ­¥å®Œæˆ (ç™¼ç¾æ–°è³‡æ–™)");
                } else {
                    console.log("âœ… åŒæ­¥å®Œæˆ (ç„¡æ–°è³‡æ–™)");
                }
            }
            isDataLoaded = true;
            hideLoadingMask();
            document.getElementById('status-text').innerHTML = "ğŸ“ GPS å¾…å‘½";
        })
        .catch(err => {
            console.error("Cloud sync failed", err);
            isDataLoaded = true;
            hideLoadingMask(); // å¤±æ•—ä¹Ÿç§»é™¤é®ç½©ï¼Œå…è¨±é›¢ç·šéŠç©
            document.getElementById('status-text').innerHTML = "âš ï¸ é›¢ç·šæ¨¡å¼";
        });
    }

    function hideLoadingMask() {
        const mask = document.getElementById('loading-mask');
        if (mask) {
            mask.style.opacity = '0';
            setTimeout(() => { mask.style.display = 'none'; }, 500);
        }
    }

    // æ¨™è¨˜åœ°é»ç‚ºå·²è¨ªå•
    function markVisited(id, isManual) {
        if(!visitLogs[id]) visitLogs[id] = [];
        visitLogs[id].push(Date.now());
        saveAndReload(false, isManual ? null : id);
    }
    
    // å„²å­˜ä¸¦åˆ·æ–°
    function saveAndReload(isRemove, alertId) {
        localStorage.setItem('bingoLogs_nccu_2026', JSON.stringify(visitLogs));
        init();
        if(alertId) {
            const locObj = locations.find(x=>x.id===alertId);
            const count = visitLogs[alertId].length;
            alert(`ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${locObj.name}\n(ç´¯ç©æ¬¡æ•¸: ${count})`);
        }
        triggerSmartSync();
    }

    // å»¶é²åŒæ­¥ (é˜²æŠ–å‹•)
    function triggerSmartSync() {
        const statusDiv = document.getElementById('status-text');
        if (syncTimer) clearTimeout(syncTimer);
        statusDiv.innerHTML = "â³ æº–å‚™åŒæ­¥...";
        syncTimer = setTimeout(() => { syncToGoogleSheet(); }, 2000);
    }

    // ä¸Šå‚³è³‡æ–™åˆ° Google Sheets
    function syncToGoogleSheet() {
        const statusDiv = document.getElementById('status-text');
        if (!isDataLoaded) { console.log("ğŸ”’ ç³»çµ±é–å®šä¸­"); return; }
        if (!liff.isLoggedIn()) { statusDiv.innerHTML = "âš ï¸ æœªç™»å…¥"; return; }
        
        statusDiv.innerHTML = "â˜ï¸ é›²ç«¯åŒæ­¥ä¸­...";
        liff.getProfile().then(profile => {
            const payload = {
                userId: profile.userId,
                name: profile.displayName,
                visitLogs: visitLogs 
            };
            // ä½¿ç”¨ no-cors æ¨¡å¼é¿å…è·¨åŸŸéŒ¯èª¤
            fetch(SYSTEM_CONFIG.googleScriptUrl, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                statusDiv.innerHTML = "âœ… è³‡æ–™å·²å­˜æª”";
                setTimeout(() => { if(!statusDiv.innerHTML.includes('ç¶“:')) statusDiv.innerHTML = "ğŸ“ GPS å¾…å‘½"; }, 2000);
            });
        });
    }

    // --- GPS å®šä½é‚è¼¯ ---
    function checkLocation() {
        const statusText = document.getElementById('status-text');
        statusText.innerHTML = "ğŸ›°ï¸ è¡›æ˜Ÿå®šä½ä¸­...";
        if (!navigator.geolocation) { alert("éŒ¯èª¤ï¼šä¸æ”¯æ´ GPS"); return; }
        
        navigator.geolocation.getCurrentPosition(position => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            let foundCount = 0;
            statusText.innerHTML = `ğŸ“ ç¶“:${userLng.toFixed(3)} ç·¯:${userLat.toFixed(3)}<br><span style='font-size:9px'>èª¤å·®ç¯„åœ: ä¾åœ°é»</span>`;
            
            locations.forEach(loc => {
                const targetRadius = loc.radius || 0.5; 
                const dist = getDistanceFromLatLonInKm(userLat, userLng, loc.lat, loc.lng);
                if (dist < targetRadius) { markVisited(loc.id, false); foundCount++; }
            });
            
            if(foundCount === 0) alert("âŒ æ‰“å¡å¤±æ•—\né™„è¿‘æ²’æœ‰è³“æœé»");
        }, error => {
            statusText.innerHTML = "âŒ å®šä½å¤±æ•—";
            alert("è«‹é–‹å•Ÿ GPS");
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }

    // Haversine å…¬å¼è¨ˆç®—è·é›¢
    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    // --- è³“æœé€£ç·šåˆ¤å®š ---
    function checkBingo() {
        let activeIds = [];
        for(let id in visitLogs) {
            if(visitLogs[id].length > 0) activeIds.push(Number(id));
        }
        const lines = [ 
            [1,2,3,4,5], [6,7,8,9,10], [11,12,13,14,15], [16,17,18,19,20], [21,22,23,24,25], // æ©«ç·š
            [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [5,10,15,20,25], // ç›´ç·š
            [1,7,13,19,25], [5,9,13,17,21] // æ–œç·š
        ];
        let winCount = 0;
        lines.forEach(line => { if (line.every(id => activeIds.includes(id))) winCount++; });
        if (winCount >= 5) document.getElementById('winner-overlay').style.display = 'flex';
        else document.getElementById('winner-overlay').style.display = 'none';
        return winCount;
    }

    // é–‹å•Ÿæˆ°ç¸¾æ¦œ
    function openRank() {
        document.getElementById('rank-overlay').style.display = 'flex';
        const listDiv = document.getElementById('rank-content');
        listDiv.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px;">è¼‰å…¥ä¸­...</p>';
        fetch(SYSTEM_CONFIG.googleScriptUrl)
        .then(response => response.json())
        .then(data => {
            let html = "";
            if(data.length === 0) {
                html = '<p style="text-align:center;margin-top:20px;">ç„¡è³‡æ–™</p>';
            } else {
                data.forEach((user, index) => {
                    let visitedNames = [];
                    if(user.visited) {
                        const ids = user.visited.toString().split(',');
                        visitedNames = ids.slice(0, 3).map(id => {
                            const loc = locations.find(l => l.id == id);
                            return loc ? loc.name : id;
                        });
                        if(ids.length > 3) visitedNames.push(`...ç­‰${ids.length}è™•`);
                    }
                    const visitedStr = visitedNames.length > 0 ? visitedNames.join('ã€') : 'å°šæœªå‡ºç™¼';
                    html += `<div class="rank-item"><div><strong>${index+1}. ${user.name}</strong><br><span style="font-size:10px; color:#888;">${visitedStr}</span></div><div style="text-align:right;"><div class="rank-line-count">${user.lines} é€£ç·š</div><span class="rank-badge">${user.points} æ ¼</span></div></div>`;
                });
            }
            listDiv.innerHTML = html;
        });
    }

    // --- ğŸ”¥ è‡ªå‹•å–šé†’æ›´æ–°æ©Ÿåˆ¶ ---
    function registerAutoSync() {
        // 1. åˆ‡æ›åˆ†é æˆ– App å›ä¾†æ™‚
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && currentUserId) {
                console.log("ğŸ‘€ è¦–çª—å–šé†’ï¼Œæª¢æŸ¥æ›´æ–°...");
                loadUserDataFromCloud(currentUserId);
            }
        });
        
        // 2. iOS Safari ä¸Šä¸€é å›ä¾†æ™‚ (Page Show)
        window.addEventListener('pageshow', (event) => {
            if (event.persisted && currentUserId) {
                console.log("ğŸ”„ iOS å¿«å–å–šé†’ï¼Œå¼·åˆ¶æ›´æ–°...");
                loadUserDataFromCloud(currentUserId);
            }
        });
    }

    // ä¸»ç¨‹å¼å…¥å£
    async function main() {
        try {
            await liff.init({ liffId: SYSTEM_CONFIG.liffId });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = `Hi, ${profile.displayName}`;
                
                // å„²å­˜ ID ä¾›è‡ªå‹•æ›´æ–°ä½¿ç”¨
                currentUserId = profile.userId;
                registerAutoSync();
                
                // é¦–æ¬¡è¼‰å…¥
                loadUserDataFromCloud(profile.userId);
            } else {
                document.getElementById('user-name').innerText = " (è¨ªå®¢æ¨¡å¼)";
                liff.login();
            }
        } catch (err) {
            document.getElementById('user-name').innerText = " (ç³»çµ±éŒ¯èª¤)";
            console.error(err);
            hideLoadingMask(); // éŒ¯èª¤ä¹Ÿè¦ç§»é™¤é®ç½©
        }
        init(); // å…ˆè¼‰å…¥æœ¬åœ°å¿«å–ç•«é¢ï¼Œè®“ä½¿ç”¨è€…ä¸ç”¨ç­‰
    }
    
    // å•Ÿå‹•
    main();
</script>
</body>
</html>
