function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  
  var userId = data.userId;
  var name = data.name;
  var points = data.points; // 完成總格數
  var lines = data.lines;   // 完成連線數
  
  // 新增：接收前端傳來的詳細地點清單 (例如 "1, 5, 25")
  // 如果前端還沒傳這個欄位，就預設空白
  var visitedList = data.visitedIds ? data.visitedIds.join(", ") : ""; 
  
  var rows = sheet.getDataRange().getValues();
  var rowIndex = -1;
  
  // 搜尋舊用戶
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] == userId) {
      rowIndex = i + 1;
      break;
    }
  }
  
  var timestamp = new Date(); 
  
  if (rowIndex > 0) {
    // 舊用戶：更新分數與詳細清單
    sheet.getRange(rowIndex, 2).setValue(name);
    sheet.getRange(rowIndex, 3).setValue(points);
    sheet.getRange(rowIndex, 4).setValue(lines);
    sheet.getRange(rowIndex, 5).setValue(timestamp);
    sheet.getRange(rowIndex, 6).setValue(visitedList); // 更新 F 欄 (已完成地點)
  } else {
    // 新用戶：新增一行
    sheet.appendRow([userId, name, points, lines, timestamp, visitedList]);
  }
  
  return ContentService.createTextOutput("Success");
}
