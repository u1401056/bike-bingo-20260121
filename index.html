<script>
    // ä½ çš„ LIFF ID
    const MY_LIFF_ID = "2008939051-CMBzqbtq";

    // æœ€çµ‚ç‰ˆ 25 å€‹åœ°é» (åŒ…å«å±å±±åœ‹å°ã€å£½å¡ã€çƒä¾†ç€‘å¸ƒç­‰)
    const locations = [
        // --- ç¬¬ä¸€æ’ï¼šæ²³æ¿±è¼•é¬†é¨ (åŒ—å€/æ·¡æ°´æ²³) ---
        { id: 1, region: "å¤§ç¨»åŸ•", name: "è²¨æ«ƒå¸‚é›†", lat: 25.0575, lng: 121.5078, icon: "â›µ" },
        { id: 2, region: "ç¤¾å­å³¶", name: "å³¶é ­å…¬åœ’", lat: 25.1097, lng: 121.4638, icon: "ğŸŒŠ" },
        { id: 3, region: "é—œæ¸¡", name: "é—œæ¸¡å®®", lat: 25.1192, lng: 121.4673, icon: "ğŸ™" },
        { id: 4, region: "æ·¡æ°´", name: "é¦¬å•ä¸Šå²¸è™•", lat: 25.1717, lng: 121.4404, icon: "â›ª" },
        { id: 5, region: "å…«é‡Œ", name: "å·¦å²¸å…¬åœ’", lat: 25.1614, lng: 121.4335, icon: "ğŸš²" },

        // --- ç¬¬äºŒæ’ï¼šæ²³æ¿±èˆ‡äººæ–‡ (è¥¿å€/å¤§æ¼¢æºª) ---
        { id: 6, region: "å…«é‡Œ", name: "å»–æ·»ä¸å»Ÿ", lat: 25.1472, lng: 121.3985, icon: "â›©ï¸" },
        { id: 7, region: "æ–°æœˆæ©‹", name: "é€æ˜æ­¥é“", lat: 25.0348, lng: 121.4506, icon: "ğŸŒ‰" },
        { id: 8, region: "æ¨¹æ—", name: "å±±ä½³ç«è»Šç«™", lat: 24.9734, lng: 121.3978, icon: "ğŸš‚" },
        { id: 9, region: "é¶¯æ­Œ", name: "é¾çª¯æ©‹", lat: 24.9537, lng: 121.3532, icon: "ğŸ‰" },
        { id: 10, region: "é¶¯æ­Œ", name: "é™¶ç“·åšç‰©é¤¨", lat: 24.9496, lng: 121.3537, icon: "ğŸº" },

        // --- ç¬¬ä¸‰æ’ï¼šè²“ç©ºèˆ‡æ·±å‘ (å—å€/ä¸˜é™µ) ---
        { id: 11, region: "è¬è¯", name: "é¦¬å ´ç”ºå…¬åœ’", lat: 25.0207, lng: 121.5032, icon: "ğŸŒ³" },
        { id: 12, region: "æœ¨æŸµ", name: "å‹•ç‰©åœ’", lat: 24.9986, lng: 121.5812, icon: "ğŸ¼" },
        { id: 13, region: "æ·±å‘", name: "å¤§èŒ„å†¬æ¨¹", lat: 25.0017, lng: 121.6147, icon: "ğŸŒ³" },
        { id: 14, region: "è²“ç©º", name: "æ˜å¾·å®®", lat: 24.9658, lng: 121.5885, icon: "â›©ï¸" },
        { id: 15, region: "è²“ç©º", name: "çºœè»Šçµ‚é»ç«™", lat: 24.9687, lng: 121.5886, icon: "ğŸš¡" },

        // --- ç¬¬å››æ’ï¼šå‹‡è…³ç·´å¡å€ (å±±è·¯æŒ‘æˆ°) ---
        { id: 16, region: "ä¸‰å³½", name: "æ¸…æ°´ç¥–å¸«å»Ÿ", lat: 24.9338, lng: 121.3703, icon: "â›©ï¸" },
        { id: 17, region: "æ–°åº—", name: "ç¢§æ½­åŠæ©‹", lat: 24.9546, lng: 121.5363, icon: "ğŸŒ‰" },
        { id: 18, region: "å£«æ—", name: "ä¸­ç¤¾è·¯é ‚", lat: 25.1031, lng: 121.5583, icon: "ğŸšŒ" },
        { id: 19, region: "å…§æ¹–", name: "åŠå—è·¯é ‚", lat: 25.0932, lng: 121.5552, icon: "ğŸ¦‹" },
        { id: 20, region: "è¬é‡Œ", name: "é¢¨æ«ƒå˜´æ¶¼äº­", lat: 25.1352, lng: 121.6026, icon: "â›°ï¸" },

        // --- ç¬¬äº”æ’ï¼šé­”ç‹èˆ‡ç§˜å¢ƒ (é•·è·é›¢/é«˜é›£åº¦) ---
        { id: 21, region: "çŸ³ç¢‡", name: "æµ·å€«å’–å•¡", lat: 24.9634, lng: 121.6247, icon: "â˜•" },
        { id: 22, region: "çƒä¾†", name: "çƒä¾†ç€‘å¸ƒ", lat: 24.8490, lng: 121.5513, icon: "ğŸŒŠ" },
        { id: 23, region: "ç¦å±±", name: "é¦¬å²¸é¤å»³", lat: 24.7746, lng: 121.5007, icon: "ğŸ¥¢" },
        { id: 24, region: "é«˜é›„", name: "å±å±±åœ‹å°", lat: 22.6908, lng: 120.3015, icon: "ğŸ«" },
        { id: 25, region: "å±æ±", name: "å£½å¡éµé¦¬é©›ç«™", lat: 22.2427, lng: 120.8561, icon: "ğŸ‘‘" }
    ];

    let savedState = JSON.parse(localStorage.getItem('bingoState_nccu_2026')) || [];
    const grid = document.getElementById('bingo-grid');
    const statusText = document.getElementById('status-text');
    let clickCounts = {};

    function init() {
        grid.innerHTML = "";
        locations.forEach(loc => {
            let cell = document.createElement('div');
            const isActive = savedState.includes(loc.id);
            cell.className = 'cell ' + (isActive ? 'active' : '');
            cell.innerHTML = `
                <div class="region">${loc.region}</div>
                <div class="icon">${loc.icon}</div>
                <div class="name">${loc.name}</div>
            `;
            
            // Debug: é€£é» 5 ä¸‹åˆ‡æ›ç‹€æ…‹ (æ‰“å¡ / å–æ¶ˆ)
            cell.onclick = () => {
                // ç§»é™¤é€™è£¡åŸæœ¬çš„ if(isActive) return; è®“å·²æ‰“å¡çš„ä¹Ÿå¯ä»¥è¢«é»æ“Š
                clickCounts[loc.id] = (clickCounts[loc.id] || 0) + 1;
                
                if(clickCounts[loc.id] >= 5) {
                    if (isActive) {
                        // å¦‚æœå·²ç¶“äº®ç‡ˆ -> å–æ¶ˆæ‰“å¡
                        savedState = savedState.filter(id => id !== loc.id);
                        alert(`âŒ å·²å–æ¶ˆï¼š${loc.name}`);
                    } else {
                        // å¦‚æœé‚„æ²’äº®ç‡ˆ -> å¼·åˆ¶æ‰“å¡
                        savedState.push(loc.id);
                        alert(`ğŸ‰ å¼·åˆ¶æ‰“å¡ï¼š${loc.name}`);
                    }
                    
                    // å­˜æª”ä¸¦é‡ç¹ª
                    localStorage.setItem('bingoState_nccu_2026', JSON.stringify(savedState));
                    clickCounts[loc.id] = 0; // é‡ç½®è¨ˆæ•¸
                    init();
                }
            };
            grid.appendChild(cell);
        });
        checkBingo();
        document.getElementById('loading').style.opacity = 0;
        setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
    }

    function markVisited(id, isManual) {
        if (!savedState.includes(id)) {
            savedState.push(id);
            localStorage.setItem('bingoState_nccu_2026', JSON.stringify(savedState));
            init();
            if(!isManual) {
                const locName = locations.find(x=>x.id===id).name;
                alert(`ğŸ‰ æ‰“å¡æˆåŠŸï¼\n${locName}`);
            }
        }
    }

    function checkLocation() {
        statusText.innerHTML = "ğŸ›°ï¸ è¡›æ˜Ÿå®šä½ä¸­...<br><span style='font-size:9px'>è«‹ä¿æŒåœ¨å®¤å¤–</span>";
        if (!navigator.geolocation) {
            alert("éŒ¯èª¤ï¼šä½ çš„è£ç½®ä¸æ”¯æ´ GPS");
            return;
        }
        navigator.geolocation.getCurrentPosition(position => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            let found = false;

            statusText.innerHTML = `ğŸ“ ç¶“:${userLng.toFixed(3)} ç·¯:${userLat.toFixed(3)}<br><span style='font-size:9px'>èª¤å·®ç¯„åœ: 500m</span>`;

            locations.forEach(loc => {
                if(savedState.includes(loc.id)) return;
                
                const dist = getDistanceFromLatLonInKm(userLat, userLng, loc.lat, loc.lng);
                if (dist < 0.5) { 
                    markVisited(loc.id, false);
                    found = true;
                }
            });

            if(!found) {
                alert("âŒ æ‰“å¡å¤±æ•—\né™„è¿‘æ²’æœ‰è³“æœé» (èª¤å·®ç¯„åœ 500m)\nå†é è¿‘ä¸€é»è©¦è©¦çœ‹ï¼");
            }
        }, error => {
            statusText.innerHTML = "âŒ å®šä½å¤±æ•—<br><span style='font-size:9px'>è«‹æª¢æŸ¥ GPS æ¬Šé™</span>";
            alert("è«‹å…è¨±ç¶²é ä½¿ç”¨ä½ç½®æ¬Šé™ï¼Œä¸¦ç¢ºèªæ‰‹æ©Ÿ GPS å·²é–‹å•Ÿã€‚");
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }

    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; 
        var dLat = deg2rad(lat2-lat1); 
        var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function checkBingo() {
        const lines = [
            [1,2,3,4,5], [6,7,8,9,10], [11,12,13,14,15], [16,17,18,19,20], [21,22,23,24,25], 
            [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [5,10,15,20,25], 
            [1,7,13,19,25], [5,9,13,17,21] 
        ];
        let winCount = 0;
        lines.forEach(line => {
            if (line.every(id => savedState.includes(id))) winCount++;
        });

        if (winCount >= 5) {
            document.getElementById('winner-overlay').style.display = 'flex';
        } else {
            document.getElementById('winner-overlay').style.display = 'none';
        }
    }
    function closeWinner() { document.getElementById('winner-overlay').style.display = 'none'; }

    async function main() {
        try {
            await liff.init({ liffId: MY_LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = `Hi, ${profile.displayName}`;
            }
        } catch (err) {
            console.error("LIFF Init Failed", err);
            document.getElementById('user-name').innerText = " (è¨ªå®¢æ¨¡å¼)";
        }
        init();
    }
    main();
</script>
